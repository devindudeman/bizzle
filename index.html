<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SF Bizzle - Daily SF Business Guessing Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #1e1e2e; /* Catppuccin Base */
            color: #cdd6f4; /* Catppuccin Text */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            font-size: 16px;
        }

        .container {
            max-width: 520px;
            width: 100%;
            margin: 0 auto;
            padding: 16px;
            flex: 1;
        }

        header {
            text-align: center;
            padding: 16px 0;
            background: linear-gradient(135deg, #313244 0%, #45475a 100%); /* Catppuccin Surface0 to Surface1 */
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid #585b70; /* Catppuccin Surface2 */
            transition: opacity 0.3s ease, transform 0.3s ease, max-height 0.3s ease, margin 0.3s ease, padding 0.3s ease;
        }

        header.hidden {
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
            margin-bottom: 0;
            max-height: 0;
            overflow: hidden;
            padding: 0;
        }

        h1 {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, #89b4fa 0%, #74c7ec 100%); /* Catppuccin Blue to Sky */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 2px;
        }

        .tagline {
            font-size: 14px;
            color: #a6adc8; /* Catppuccin Subtext1 */
            font-weight: 500;
            margin-top: 4px;
        }

        /* Footer Settings */
        .footer-settings {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 12px;
            z-index: 100;
        }

        .settings-button {
            background: rgba(49, 50, 68, 0.9); /* Catppuccin Surface0 */
            border: 1px solid #585b70; /* Catppuccin Surface2 */
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            transition: all 0.2s ease;
            opacity: 0.8;
            color: #cdd6f4; /* Catppuccin Text */
        }

        .settings-button:hover {
            opacity: 1;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
            background: rgba(69, 71, 90, 0.9); /* Catppuccin Surface1 */
        }

        .settings-button.karl-toggle {
            opacity: 0.6;
        }

        .settings-button.karl-toggle:hover {
            opacity: 1;
        }

        .settings-button.karl-disabled {
            opacity: 0.3;
            filter: grayscale(100%);
        }

        .why-bizzle-button {
            background: none;
            border: none;
            color: #a6adc8; /* Catppuccin Subtext1 */
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 16px;
            margin: 4px 0 2px 0;
            transition: all 0.2s ease;
            text-decoration: underline;
            text-decoration-style: dotted;
        }

        .why-bizzle-button:hover {
            color: #89b4fa; /* Catppuccin Blue */
            background: rgba(137, 180, 250, 0.1);
            text-decoration: solid;
        }

        .game-number {
            font-size: 12px;
            color: #a6adc8; /* Catppuccin Subtext1 */
            margin-top: 4px;
            font-weight: 600;
            background: rgba(137, 180, 250, 0.1); /* Catppuccin Blue tint */
            padding: 3px 10px;
            border-radius: 16px;
            display: inline-block;
        }

        .photo-container {
            width: 100%;
            max-height: 300px;
            overflow: hidden;
            border-radius: 16px;
            margin-bottom: 24px;
            background: #E5E5E5;
            position: relative;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            border: 3px solid white;
        }

        .photo-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #a6adc8; /* Catppuccin Subtext1 */
        }

        .fun-fact {
            background: linear-gradient(135deg, #f9e2af 0%, #f2d5cf 100%); /* Catppuccin Yellow to Rosewater */
            border: 1px solid #f9e2af; /* Catppuccin Yellow */
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 14px;
            line-height: 1.5;
            box-shadow: 0 2px 4px rgba(249, 226, 175, 0.3);
            color: #1e1e2e; /* Catppuccin Base for contrast */
        }

        .clue-label {
            font-weight: 700;
            color: #f38ba8; /* Catppuccin Pink */
            margin-bottom: 4px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .new-hints {
            margin-bottom: 16px;
        }

        .new-hints .hint {
            margin-bottom: 8px;
        }

        .new-hints .hint:first-child {
            border: 3px solid #74c7ec; /* Catppuccin Sky */
            box-shadow: 0 6px 20px rgba(116, 199, 236, 0.4);
            transform: scale(1.02);
        }

        .hint {
            background: linear-gradient(135deg, #74c7ec 0%, #89b4fa 100%); /* Catppuccin Sky to Blue */
            border: 2px solid #74c7ec; /* Catppuccin Sky */
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: block;
            animation: slideInFromTop 0.5s ease-out;
            box-shadow: 0 2px 8px rgba(116, 199, 236, 0.3);
            font-size: 14px;
            font-weight: 500;
            opacity: 0;
            transform: translateY(-20px);
            color: #1e1e2e; /* Catppuccin Base for contrast */
        }

        .hint.revealed {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.5s ease-out;
        }

        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hint.revealed {
            display: block;
        }

        .hint-label {
            font-weight: 700;
            color: #1E40AF;
            font-size: 14px;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.75px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .guess-section {
            margin-bottom: 16px;
            position: relative;
            background: #313244; /* Catppuccin Surface0 */
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid #585b70; /* Catppuccin Surface2 */
        }

        .guess-counter {
            font-weight: 500;
            font-size: 12px;
            color: #a6adc8; /* Catppuccin Subtext1 */
            background: #45475a; /* Catppuccin Surface1 */
            padding: 4px 12px;
            border-radius: 16px;
            display: inline-block;
        }

        .guess-counter.warning {
            color: #fab387; /* Catppuccin Peach */
            background: rgba(250, 179, 135, 0.2);
        }

        .guess-counter.danger {
            color: #f38ba8; /* Catppuccin Pink */
            background: rgba(243, 139, 168, 0.2);
        }

        .give-up-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
        }

        .button-group {
            display: flex;
            gap: 8px;
        }

        .give-up-button {
            background: #6c7086; /* Catppuccin Overlay0 */
            color: #cdd6f4; /* Catppuccin Text */
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.7;
        }

        .give-up-button:hover:not(:disabled) {
            background: #585b70; /* Catppuccin Surface2 */
            opacity: 1;
            transform: translateY(-1px);
        }

        .give-up-button:disabled {
            background: #6c7086; /* Catppuccin Overlay0 */
            cursor: not-allowed;
            opacity: 0.3;
        }

        .multiple-choice-button {
            background: linear-gradient(135deg, #89b4fa 0%, #74c7ec 100%); /* Catppuccin Blue to Sky */
            color: #1e1e2e; /* Catppuccin Base for contrast */
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.8;
        }

        .multiple-choice-button:hover:not(:disabled) {
            background: linear-gradient(135deg, #74c7ec 0%, #89dceb 100%); /* Catppuccin Sky to Sapphire */
            opacity: 1;
            transform: translateY(-1px);
        }

        .multiple-choice-button:disabled {
            background: #6c7086; /* Catppuccin Overlay0 */
            color: #a6adc8; /* Catppuccin Subtext1 */
            cursor: not-allowed;
            opacity: 0.3;
        }

        .guess-input-container {
            position: relative;
        }

        .guess-input {
            width: 100%;
            height: 56px;
            padding: 0 60px 0 20px;
            font-size: 18px;
            font-weight: 500;
            border: 3px solid #585b70; /* Catppuccin Surface2 */
            border-radius: 12px;
            transition: all 0.3s ease;
            background: #45475a; /* Catppuccin Surface1 */
            color: #cdd6f4; /* Catppuccin Text */
        }

        .guess-input:focus {
            outline: none;
            border-color: #89b4fa; /* Catppuccin Blue */
            background: #585b70; /* Catppuccin Surface2 */
            box-shadow: 0 0 0 4px rgba(137, 180, 250, 0.2);
            transform: translateY(-1px);
        }

        .guess-input::placeholder {
            color: #9399b2; /* Catppuccin Overlay1 */
        }

        .guess-input:disabled {
            background: #45475a; /* Catppuccin Surface1 */
            cursor: not-allowed;
            opacity: 0.5;
        }

        .submit-button {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #89b4fa 0%, #74c7ec 100%); /* Catppuccin Blue to Sky */
            color: #1e1e2e; /* Catppuccin Base for contrast */
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(137, 180, 250, 0.3);
        }

        .submit-button:hover:not(:disabled) {
            background: linear-gradient(135deg, #74c7ec 0%, #89dceb 100%); /* Catppuccin Sky to Sapphire */
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 4px 12px rgba(116, 199, 236, 0.4);
        }

        .submit-button:disabled {
            background: #6c7086; /* Catppuccin Overlay0 */
            cursor: not-allowed;
            opacity: 0.5;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #45475a; /* Catppuccin Surface1 */
            border: 1px solid #585b70; /* Catppuccin Surface2 */
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            margin-top: 4px;
            display: none;
        }

        .autocomplete-dropdown.active {
            display: block;
        }

        .autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #585b70; /* Catppuccin Surface2 */
            color: #cdd6f4; /* Catppuccin Text */
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: #585b70; /* Catppuccin Surface2 */
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .guesses-grid {
            display: none !important;
        }

        .guesses-grid::before {
            content: "Your Guesses";
            position: absolute;
            top: -12px;
            left: 16px;
            background: #F8FAFC;
            padding: 0 8px;
            font-size: 12px;
            font-weight: 600;
            color: #64748B;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .guess-slot {
            height: 52px;
            background: white;
            border: 2px dashed #CBD5E1;
            border-radius: 10px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            color: #64748B;
        }

        .guess-slot.correct {
            background: linear-gradient(135deg, #a6e3a1 0%, #94e2d5 100%); /* Catppuccin Green to Teal */
            color: #1e1e2e; /* Catppuccin Base for contrast */
            border: 2px solid #a6e3a1; /* Catppuccin Green */
            box-shadow: 0 2px 8px rgba(166, 227, 161, 0.4);
            transform: scale(1.02);
        }

        .guess-slot.wrong {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            color: white;
            border: 2px solid #DC2626;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        .game-end {
            display: none;
            text-align: center;
            padding: 20px;
            background: #313244; /* Catppuccin Surface0 */
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: 3px solid #a6e3a1; /* Catppuccin Green */
        }

        .game-end.show {
            display: block !important;
            animation: slideIn 0.5s ease-out;
        }

        .result-message {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .result-message.win {
            color: #a6e3a1; /* Catppuccin Green */
        }

        .result-message.lose {
            color: #EF4444;
        }

        .business-name-reveal {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .business-details {
            text-align: left;
            background: #45475a; /* Catppuccin Surface1 */
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
            border: 1px solid #585b70; /* Catppuccin Surface2 */
        }

        .business-details p {
            margin-bottom: 8px;
            font-size: 14px;
        }

        .business-details strong {
            color: #89b4fa; /* Catppuccin Blue */
        }

        .business-details a {
            color: #74c7ec; /* Catppuccin Sky */
            text-decoration: none;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Courier New', monospace;
            font-weight: 500;
            padding: 2px 6px;
            background: rgba(116, 199, 236, 0.1);
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .business-details a:hover {
            color: #89dceb; /* Catppuccin Sapphire */
            background: rgba(116, 199, 236, 0.2);
            transform: translateY(-1px);
        }

        .share-button {
            background: linear-gradient(135deg, #89b4fa 0%, #74c7ec 100%); /* Catppuccin Blue to Sky */
            color: #1e1e2e; /* Catppuccin Base for contrast */
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 16px;
        }

        .share-button:hover {
            background: linear-gradient(135deg, #74c7ec 0%, #89dceb 100%); /* Catppuccin Sky to Sapphire */
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(116, 199, 236, 0.3);
        }

        .share-button.copied {
            background: #a6e3a1; /* Catppuccin Green */
            color: #1e1e2e; /* Catppuccin Base for contrast */
        }

        .countdown {
            margin-top: 20px;
            padding: 16px;
            background: #45475a; /* Catppuccin Surface1 */
            border-radius: 8px;
            text-align: center;
            border: 1px solid #585b70; /* Catppuccin Surface2 */
        }

        .countdown-label {
            font-size: 14px;
            color: #a6adc8; /* Catppuccin Subtext1 */
            margin-bottom: 8px;
        }

        .countdown-time {
            font-size: 24px;
            font-weight: 700;
            color: #89b4fa; /* Catppuccin Blue */
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(30, 30, 46, 0.8); /* Catppuccin Base with transparency */
            z-index: 1000;
            padding: 20px;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #313244; /* Catppuccin Surface0 */
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid #585b70; /* Catppuccin Surface2 */
            color: #cdd6f4; /* Catppuccin Text */
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .stats-grid .stat-item:nth-child(n+4) {
            grid-column: span 1;
        }

        .stat-item {
            text-align: center;
            padding: 16px;
            background: #F3F4F6;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #89b4fa; /* Catppuccin Blue */
        }

        .stat-label {
            font-size: 12px;
            color: #a6adc8; /* Catppuccin Subtext1 */
            margin-top: 4px;
        }

        .debug-options {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .debug-section {
            border-bottom: 1px solid #585b70; /* Catppuccin Surface2 */
            padding-bottom: 16px;
        }

        .debug-section:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .debug-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #cdd6f4; /* Catppuccin Text */
        }

        .debug-section p {
            font-size: 14px;
            margin-bottom: 8px;
            color: #a6adc8; /* Catppuccin Subtext1 */
        }

        .debug-section strong {
            color: #89b4fa; /* Catppuccin Blue */
        }

        .debug-section span {
            color: #cdd6f4; /* Catppuccin Text */
        }

        .debug-btn {
            background: #6c7086; /* Catppuccin Overlay0 */
            color: #cdd6f4; /* Catppuccin Text */
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            margin: 4px 8px 4px 0;
            transition: background 0.2s;
        }

        .debug-btn:hover {
            background: #4B5563;
        }

        .debug-btn.danger {
            background: #DC2626;
        }

        .debug-btn.danger:hover {
            background: #B91C1C;
        }

        /* Tutorial Styles */
        .tutorial-content {
            max-height: 70vh;
            overflow-y: auto;
        }

        .tutorial-step {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            padding: 16px;
            background: #F8FAFC;
            border-radius: 12px;
            border-left: 4px solid #3B82F6;
        }

        .step-number {
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            background: #3B82F6;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
        }

        .step-content h3 {
            margin: 0 0 8px 0;
            font-size: 18px;
            font-weight: 600;
            color: #1F2937;
        }

        .step-content p {
            margin: 0 0 8px 0;
            color: #4B5563;
            line-height: 1.5;
        }

        .step-content p:last-child {
            margin-bottom: 0;
        }

        .tutorial-start-btn {
            width: 100%;
            background: #10B981;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 24px;
            transition: background 0.2s;
        }

        .tutorial-start-btn:hover {
            background: #059669;
        }

        /* Why Bizzle Modal Styles */
        .why-bizzle-content {
            max-height: 70vh;
            overflow-y: auto;
        }

        .mission-section {
            margin-bottom: 24px;
            padding: 20px;
            background: #F8FAFC;
            border-radius: 12px;
            border-left: 4px solid #10B981;
        }

        .mission-section h3 {
            margin: 0 0 12px 0;
            font-size: 18px;
            font-weight: 600;
            color: #1F2937;
        }

        .mission-section p {
            margin: 0;
            color: #4B5563;
            line-height: 1.6;
            font-size: 15px;
        }

        .cta-section {
            text-align: center;
            padding: 24px;
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            border-radius: 12px;
            color: white;
            margin-top: 8px;
        }

        .cta-section p {
            margin: 0;
            font-size: 16px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Karl the Fog Styles */
        .karl-the-fog {
            position: fixed;
            width: 80px;
            height: 60px;
            opacity: 0.3;
            z-index: 1000;
            pointer-events: none;
            transition: transform 0.1s ease-out;
            user-select: none;
        }

        .karl-cloud {
            position: relative;
            width: 80px;
            height: 40px;
            background: #E5E7EB;
            border-radius: 50px;
            animation: karl-float 6s ease-in-out infinite;
        }

        .karl-cloud::before {
            content: '';
            position: absolute;
            top: -20px;
            left: 15px;
            width: 30px;
            height: 30px;
            background: #E5E7EB;
            border-radius: 50%;
        }

        .karl-cloud::after {
            content: '';
            position: absolute;
            top: -15px;
            right: 10px;
            width: 25px;
            height: 25px;
            background: #E5E7EB;
            border-radius: 50%;
        }

        .karl-eyes {
            position: absolute;
            top: 8px;
            left: 25px;
            display: flex;
            gap: 8px;
        }

        .karl-eye {
            width: 8px;
            height: 8px;
            background: #374151;
            border-radius: 50%;
            animation: karl-blink 4s infinite;
        }

        .karl-mouth {
            position: absolute;
            top: 22px;
            left: 32px;
            width: 16px;
            height: 8px;
            border: 2px solid #374151;
            border-top: none;
            border-radius: 0 0 50px 50px;
            animation: karl-smile 8s ease-in-out infinite;
        }

        @keyframes karl-float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes karl-blink {
            0%, 90%, 100% { transform: scaleY(1); }
            95% { transform: scaleY(0.1); }
        }

        @keyframes karl-smile {
            0%, 70%, 100% { transform: scaleX(1); }
            85% { transform: scaleX(1.2); }
        }

        @keyframes karl-drift {
            0% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(50px, -30px) rotate(5deg); }
            50% { transform: translate(-20px, -60px) rotate(-3deg); }
            75% { transform: translate(-50px, -20px) rotate(2deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }

        /* Map Styles */
        .map-container {
            margin-bottom: 24px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 2px solid #E5E7EB;
        }

        .map {
            width: 100%;
            height: 300px;
        }

        .map-label {
            display: none;
        }

        /* Multiple Choice Styles */
        .multiple-choice-container {
            margin-bottom: 24px;
        }

        .choice-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
            text-align: center;
            font-size: 16px;
        }

        .choice-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }

        .choice-button {
            background: white;
            border: 2px solid #E5E7EB;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-weight: 500;
        }

        .choice-button:hover {
            border-color: #3B82F6;
            background: #F8FAFC;
            transform: translateY(-1px);
        }

        .choice-button.correct {
            background: linear-gradient(135deg, #a6e3a1 0%, #94e2d5 100%); /* Catppuccin Green to Teal */
            border-color: #a6e3a1; /* Catppuccin Green */
            color: #1e1e2e; /* Catppuccin Base for contrast */
        }

        .choice-button.wrong {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            border-color: #DC2626;
            color: white;
        }

        .error-message {
            background: #FEE2E2;
            color: #991B1B;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Achievement System Styles */
        .achievement-popup {
            position: fixed !important;
            top: 80px !important;
            right: 20px !important;
            background: linear-gradient(135deg, #a6e3a1 0%, #94e2d5 100%); /* Catppuccin Green to Teal */
            color: #1e1e2e; /* Catppuccin Base for contrast */
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(166, 227, 161, 0.4);
            border: 2px solid #a6e3a1; /* Catppuccin Green */"
            z-index: 999999 !important;
            max-width: 300px;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.5s ease-out;
        }
        
        .achievement-popup.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .achievement-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .achievement-emoji {
            font-size: 32px;
            line-height: 1;
        }
        
        .achievement-text {
            flex: 1;
        }
        
        .achievement-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.9;
            margin-bottom: 2px;
        }
        
        .achievement-name {
            font-size: 16px;
            font-weight: 700;
            line-height: 1.2;
        }
        
        /* Achievement Showcase Styles */
        .achievement-showcase {
            border-top: 1px solid #585b70; /* Catppuccin Surface2 */
            padding-top: 20px;
            margin-top: 16px;
        }
        
        .achievement-showcase h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            color: #cdd6f4; /* Catppuccin Text */
            text-align: center;
        }
        
        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }
        
        .achievement-badge {
            background: #45475a; /* Catppuccin Surface1 */
            border: 2px solid #585b70; /* Catppuccin Surface2 */
            border-radius: 12px;
            padding: 16px 8px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .achievement-badge.unlocked {
            background: linear-gradient(135deg, #f9e2af 0%, #f2d5cf 100%); /* Catppuccin Yellow to Rosewater */
            border-color: #f9e2af; /* Catppuccin Yellow */
            box-shadow: 0 2px 8px rgba(249, 226, 175, 0.3);
            transform: scale(1.02);
        }
        
        .achievement-badge.locked {
            opacity: 0.5;
        }
        
        .achievement-badge-emoji {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
            filter: grayscale(100%);
        }
        
        .achievement-badge.unlocked .achievement-badge-emoji {
            filter: none;
        }
        
        .achievement-badge-name {
            font-size: 12px;
            font-weight: 600;
            color: #a6adc8; /* Catppuccin Subtext1 */
            line-height: 1.3;
        }
        
        .achievement-badge.unlocked .achievement-badge-name {
            color: #1e1e2e; /* Catppuccin Base for contrast on yellow background */
        }
        
        /* Visit Tracking Styles */
        .visit-actions {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #E5E7EB;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .visit-button {
            background: linear-gradient(135deg, #a6e3a1 0%, #94e2d5 100%); /* Catppuccin Green to Teal */
            color: #1e1e2e; /* Catppuccin Base for contrast */
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .visit-button:hover {
            background: linear-gradient(135deg, #94e2d5 0%, #a6e3a1 100%); /* Reverse gradient */
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(166, 227, 161, 0.4);
        }
        
        .wishlist-button {
            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .wishlist-button:hover {
            background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .directions-button {
            display: block;
            background: #45475a; /* Catppuccin Surface1 */
            color: #cdd6f4; /* Catppuccin Text */
            text-decoration: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid #585b70; /* Catppuccin Surface2 */
        }
        
        .directions-button:hover {
            background: #585b70; /* Catppuccin Surface2 */
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .visited-badge {
            background: linear-gradient(135deg, #f9e2af 0%, #f2d5cf 100%); /* Catppuccin Yellow to Rosewater */
            color: #1e1e2e; /* Catppuccin Base for contrast */
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            border: 2px solid #F59E0B;
        }

        @media (max-width: 480px) {
            .container {
                padding: 12px;
            }

            header {
                padding: 12px 0;
                margin-bottom: 12px;
            }

            h1 {
                font-size: 24px;
                margin-bottom: 2px;
            }

            .tagline {
                font-size: 13px;
            }

            .footer-settings {
                bottom: 16px;
                right: 16px;
                gap: 8px;
            }

            .settings-button {
                width: 44px;
                height: 44px;
                font-size: 18px;
            }

            .guess-section {
                padding: 12px;
                margin-bottom: 12px;
            }

            .guess-input {
                height: 52px;
                font-size: 16px;
                padding: 0 56px 0 16px;
            }

            .submit-button {
                width: 40px;
                height: 40px;
            }

            .photo-container {
                max-height: 250px;
                margin-bottom: 20px;
            }

            .guesses-grid {
                padding: 12px;
            }

            .guess-slot {
                height: 48px;
                font-size: 15px;
            }

            .give-up-button {
                font-size: 11px;
                padding: 6px 12px;
            }

            .multiple-choice-button {
                font-size: 11px;
                padding: 6px 12px;
            }

            .give-up-container {
                flex-direction: column;
                gap: 12px;
                align-items: center;
            }

            .button-group {
                gap: 8px;
                justify-content: center;
            }

            .map {
                height: 250px;
            }

            .choice-grid {
                gap: 6px;
            }

            .choice-button {
                padding: 10px 12px;
                font-size: 14px;
            }
            
            .achievement-popup {
                right: 16px;
                max-width: calc(100vw - 32px);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>SF Bizzle</h1>
            <p class="tagline">How well do you know SF?</p>
            <button class="why-bizzle-button" onclick="showWhyBizzle()">Why Bizzle? üíù</button>
            <p class="game-number" id="gameNumber"></p>
        </header>

        <div class="error-message" id="errorMessage"></div>

        <div class="loading" id="loading">
            <span>Loading today's business...</span>
        </div>

        <div id="gameContent" style="display: none;">
            <!-- Guess Section at Top -->
            <div id="guessSection" class="guess-section">
                <div class="guess-input-container">
                    <input type="text" 
                           id="guessInput" 
                           class="guess-input" 
                           placeholder="Guess the Biz"
                           autocomplete="off">
                    <button id="submitButton" class="submit-button" onclick="submitGuess()" title="Submit guess">‚Üí</button>
                    <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
                </div>
                <div class="give-up-container">
                    <div class="button-group">
                        <button id="multipleChoiceButton" class="multiple-choice-button" onclick="skipToMultipleChoice()" title="Skip to map and multiple choice">üó∫Ô∏è Multiple Choice</button>
                        <button id="giveUpButton" class="give-up-button" onclick="giveUp()" title="Reveal the answer">üè≥Ô∏è I give up</button>
                    </div>
                    <div class="guess-counter">
                        <span id="guessCounter">5 guesses remaining</span>
                    </div>
                </div>
            </div>

            <!-- Game End Section (NEW CONTENT AT TOP) -->
            <div class="game-end" id="gameEnd">
                <div class="result-message" id="resultMessage"></div>
                <div class="business-name-reveal" id="businessNameReveal"></div>
                <div class="business-details" id="businessDetails"></div>
                <button class="share-button" id="shareButton" onclick="shareResult()">Share Result</button>
                <div class="countdown">
                    <div class="countdown-label">Next Bizzle in</div>
                    <div class="countdown-time" id="countdownTime"></div>
                </div>
            </div>

            <!-- Dynamic Hints Section (newest hints at top) -->
            <div class="new-hints" id="newHints">
                <!-- Hints will be dynamically prepended here, newest first -->
            </div>

            <!-- Map Section (shown during multiple choice phase) -->
            <div class="map-container" id="mapContainer" style="display: none;">
                <div id="map" class="map"></div>
                <div class="map-label">üó∫Ô∏è Find the business on the map</div>
            </div>

            <!-- Multiple Choice Section -->
            <div class="multiple-choice-container" id="multipleChoiceContainer" style="display: none;">
                <div class="choice-label">Choose the correct business:</div>
                <div class="choice-grid" id="choiceGrid">
                    <!-- Multiple choice buttons will be added dynamically -->
                </div>
            </div>

            <!-- Photo Section (always visible baseline) -->
            <div class="photo-container">
                <img id="businessPhoto" alt="Business interior photo">
            </div>

            <!-- Fun Fact Section (always visible baseline) -->
            <div class="fun-fact">
                <div class="clue-label">üí° Fun Fact</div>
                <div id="funFact"></div>
            </div>

            <!-- Previous Guesses Display (shown at bottom after game ends) -->
            <div class="guesses-grid" id="guessesGrid" style="display: none;">
                <!-- Guess slots will be added dynamically -->
            </div>
        </div>
    </div>

    <!-- Footer with Settings -->
    <div class="footer-settings">
        <button class="settings-button" onclick="showStats()" aria-label="View Statistics" title="Statistics">üìä</button>
        <button class="settings-button karl-toggle" onclick="toggleKarl()" aria-label="Toggle Karl the Fog" id="karlToggle" title="Toggle Karl the Fog">üå´Ô∏è</button>
        <button class="settings-button" onclick="showDebug()" aria-label="Debug Menu" title="Debug Menu">üîß</button>
    </div>

    <div class="modal" id="statsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Statistics</h2>
                <button class="close-button" onclick="closeStats()">√ó</button>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="gamesPlayed">0</div>
                    <div class="stat-label">Games Played</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="winPercentage">0%</div>
                    <div class="stat-label">Win Rate</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="currentStreak">0</div>
                    <div class="stat-label">Current Streak</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="maxStreak">0</div>
                    <div class="stat-label">Max Streak</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalPoints">0</div>
                    <div class="stat-label">Total Points</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="achievementCount">0</div>
                    <div class="stat-label">Achievements</div>
                </div>
            </div>
            <div class="achievement-showcase">
                <h3>üèÜ Achievements</h3>
                <div class="achievement-grid" id="achievementGrid">
                    <!-- Achievements will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="debugModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üîß Debug Menu</h2>
                <button class="close-button" onclick="closeDebug()">√ó</button>
            </div>
            <div class="debug-options">
                <div class="debug-section">
                    <h3>Clear Data</h3>
                    <button class="debug-btn" onclick="clearTodaysGame()">Reset Today's Game</button>
                    <button class="debug-btn" onclick="clearAllStats()">Clear All Statistics</button>
                    <button class="debug-btn" onclick="clearBusinessCache()">Clear Business Cache</button>
                    <button class="debug-btn danger" onclick="clearAllData()">Clear Everything</button>
                </div>
                <div class="debug-section">
                    <h3>API Testing</h3>
                    <button class="debug-btn" onclick="testPlacesAPI()">Test Places API</button>
                </div>
                <div class="debug-section">
                    <h3>Date Testing</h3>
                    <label for="debugDatePicker" style="display: block; margin-bottom: 8px; color: #a6adc8; font-size: 12px;">Select Date to Test:</label>
                    <input type="date" id="debugDatePicker" style="margin-bottom: 12px; padding: 6px; border: 1px solid #585b70; background: #45475a; color: #cdd6f4; border-radius: 4px; font-size: 12px;">
                    <button class="debug-btn" onclick="loadDateForTesting()">Load Selected Date</button>
                    <button class="debug-btn" onclick="resetToToday()">Reset to Today</button>
                </div>
                <div class="debug-section">
                    <h3>Game Info</h3>
                    <p><strong>Day:</strong> <span id="debugDay"></span></p>
                    <p><strong>Guesses:</strong> <span id="debugGuesses"></span></p>
                    <p><strong>Game State:</strong> <span id="debugState"></span></p>
                    <p><strong>Business:</strong> <span id="debugBusiness"></span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tutorial Modal -->
    <div class="modal" id="tutorialModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üéÆ How to Play Bizzle</h2>
                <button class="close-button" onclick="closeTutorial()">√ó</button>
            </div>
            <div class="tutorial-content">
                <div class="tutorial-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h3>üì∏ Study the Photo</h3>
                        <p>Look at the interior photo and read the fun fact about today's mystery business.</p>
                    </div>
                </div>
                <div class="tutorial-step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h3>‚úèÔ∏è Make Your Guess</h3>
                        <p>Type the business name - autocomplete will help you find SF businesses!</p>
                    </div>
                </div>
                <div class="tutorial-step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h3>üó∫Ô∏è Use the Map</h3>
                        <p>After your first wrong guess, an interactive map appears with multiple choice options. Each wrong answer reveals more hints and zooms closer!</p>
                    </div>
                </div>
                <div class="tutorial-step">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <h3>üéØ Earn Points</h3>
                        <p><strong>5 pts</strong> first guess ‚Ä¢ <strong>4 pts</strong> second guess ‚Ä¢ <strong>3 pts</strong> third guess ‚Ä¢ <strong>2 pts</strong> fourth guess ‚Ä¢ <strong>1 pt</strong> fifth guess</p>
                        <p>Get <strong>+2 bonus points</strong> when you mark a place as visited!</p>
                    </div>
                </div>
                <div class="tutorial-step">
                    <div class="step-number">5</div>
                    <div class="step-content">
                        <h3>üèÜ Unlock Achievements</h3>
                        <p>Build streaks, score perfectly, discover new places, and visit businesses in real life to earn achievement badges!</p>
                    </div>
                </div>
                <button class="tutorial-start-btn" onclick="closeTutorial()">Start Playing! üöÄ</button>
            </div>
        </div>
    </div>

    <!-- Why Bizzle Modal -->
    <div class="modal" id="whyBizzleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üíù Why Bizzle?</h2>
                <button class="close-button" onclick="closeWhyBizzle()">√ó</button>
            </div>
            <div class="why-bizzle-content">
                <div class="mission-section">
                    <h3>üè™ Our Mission</h3>
                    <p>We believe in the power of community and the importance of supporting local small businesses. Every neighborhood gem has a story, and every local business owner has poured their heart into creating something special.</p>
                </div>
                
                <div class="mission-section">
                    <h3>üåü Why Shopping Local Matters</h3>
                    <p>When you visit a local business, you're not just making a purchase‚Äîyou're investing in your community, supporting someone's dream, and helping preserve the unique character that makes San Francisco special.</p>
                </div>
                
                <div class="mission-section">
                    <h3>üîç Discover Hidden Gems</h3>
                    <p>San Francisco is full of incredible small businesses that deserve to be discovered! Bizzle is our way of helping you explore the amazing places in your backyard and connecting you with the passionate people behind them.</p>
                </div>
                
            </div>
        </div>
    </div>

    <!-- Karl the Fog -->
    <div class="karl-the-fog" id="karlTheFog">
        <div class="karl-cloud">
            <div class="karl-eyes">
                <div class="karl-eye"></div>
                <div class="karl-eye"></div>
            </div>
            <div class="karl-mouth"></div>
        </div>
    </div>

    <!-- Google Maps JavaScript API with proper async loading -->
    <script>
        // Modern async Google Maps loading
        function initGoogleMaps() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyAkcxjO6ptmguM6UnYEu2CkdI2cIcsr5Ww&libraries=places,marker&callback=onGoogleMapsReady&loading=async`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }
        
        // Callback when Google Maps is ready
        function onGoogleMapsReady() {
            console.log('Google Maps API loaded successfully');
            window.googleMapsReady = true;
            // Initialize map if game content is already visible
            if (document.getElementById('gameContent').style.display !== 'none') {
                initializeMapIfNeeded();
            }
        }
        
        // Load Google Maps when page is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initGoogleMaps);
        } else {
            initGoogleMaps();
        }
    </script>
    
    <script>
        // Configuration Object - All game settings in one place
        const CONFIG = {
            // API Configuration
            SHEET_ID: '1aCuaC2pMPs7cnaBc9-reGxq8SKJIpIaCRd6rhUtTJgg',
            API_KEY: 'AIzaSyAkcxjO6ptmguM6UnYEu2CkdI2cIcsr5Ww',
            SHEET_RANGE: 'Sheet1!A:J',
            
            // Game Settings
            MAX_GUESSES: 5,
            GAME_START_DATE: '2025-08-10',
            FUZZY_MATCH_THRESHOLD: 0.8,
            
            // Points System
            POINTS: {
                FIRST_GUESS: 5,
                SECOND_GUESS: 4,
                THIRD_GUESS: 3,
                FOURTH_GUESS: 2,
                FIFTH_GUESS: 1,
                NO_POINTS: 0
            },
            
            // Map Configuration
            SF_CENTER: { lat: 37.7749, lng: -122.4194 },
            ZOOM_LEVELS: {
                1: { zoom: 11, label: 'City-wide' },
                2: { zoom: 13, label: 'Region' },
                3: { zoom: 15, label: 'Neighborhood' },
                4: { zoom: 17, label: 'Street' },
                5: { zoom: 19, label: 'Exact' }
            },
            
            // Round Configuration
            ROUNDS: {
                2: { radius: 8, maxOptions: 8, label: 'SF-wide' },
                3: { radius: 2, maxOptions: 6, label: 'Neighborhood' },
                4: { radius: 0.5, maxOptions: 4, label: 'Nearby' }
            },
            
            // Timing Configuration
            TIMEOUTS: {
                MAP_SETTLE: 1000,
                CHOICE_FEEDBACK: 1500,
                WIN_CELEBRATION: 1500,
                LOSE_REVEAL: 1000,
                MARKER_DROP: 800,
                INFO_WINDOW: 1000
            },
            
            // Cache Configuration
            CACHE_DURATION: 24 * 60 * 60 * 1000, // 24 hours in milliseconds
            
            // Hint Configuration
            HINTS: {
                1: { label: 'üìç Neighborhood', field: 'Neighborhood' },
                2: { label: '‚≠ê Signature Item', field: 'Signature' },
                3: { label: 'üè∑Ô∏è Category', field: 'Category' },
                4: { label: 'üõ£Ô∏è Street', field: 'Street' }
            },
            
            // Achievement Configuration
            ACHIEVEMENTS: {
                // Streak Achievements
                streak_3: { name: '3-Day Streak', emoji: 'üî•', description: 'Play for 3 days in a row', type: 'streak' },
                streak_7: { name: '7-Day Streak', emoji: '‚ö°', description: 'Play for 7 days in a row', type: 'streak' },
                streak_15: { name: '15-Day Streak', emoji: 'üåü', description: 'Play for 15 days in a row', type: 'streak' },
                streak_30: { name: '30-Day Streak', emoji: 'üëë', description: 'Play for 30 days in a row', type: 'streak' },
                
                // Score Achievements
                perfect: { name: 'Perfect Score', emoji: 'üéØ', description: 'Get 5 points in a single game', type: 'score' },
                lightning: { name: 'Lightning Round', emoji: '‚ö°', description: 'Get 4+ points in 5 different games', type: 'score' },
                centurion: { name: 'Centurion', emoji: 'üíØ', description: 'Reach 100 total points', type: 'score' },
                
                // Discovery Achievements
                first_timer: { name: 'First Timer', emoji: 'üéâ', description: 'Win your first game', type: 'discovery' },
                explorer: { name: 'Explorer', emoji: 'üó∫Ô∏è', description: 'Win 10 games', type: 'discovery' },
                local_expert: { name: 'Local Expert', emoji: 'üèÜ', description: 'Win 25 games', type: 'discovery' },
                
                // Visit Achievements
                adventurer: { name: 'Adventurer', emoji: 'üö∂', description: 'Visit 1 business in real life', type: 'visit' },
                foodie: { name: 'Foodie', emoji: 'üçΩÔ∏è', description: 'Visit 5 businesses in real life', type: 'visit' },
                local_legend: { name: 'Local Legend', emoji: 'üåÜ', description: 'Visit 15 businesses in real life', type: 'visit' }
            },
            
            // Visit Bonus Points
            VISIT_BONUS: 2
        };
        
        // DOM Elements Cache - populated on initialization
        let domElements = {};
        
        /**
         * Initialize DOM element cache to avoid repeated getElementById calls
         */
        function initializeDOMCache() {
            domElements = {
                // Loading and content
                loading: document.getElementById('loading'),
                gameContent: document.getElementById('gameContent'),
                errorMessage: document.getElementById('errorMessage'),
                
                // Header elements
                gameNumber: document.getElementById('gameNumber'),
                
                // Game elements
                guessSection: document.getElementById('guessSection'),
                guessCounter: document.getElementById('guessCounter'),
                guessInput: document.getElementById('guessInput'),
                submitButton: document.getElementById('submitButton'),
                giveUpButton: document.getElementById('giveUpButton'),
                multipleChoiceButton: document.getElementById('multipleChoiceButton'),
                autocompleteDropdown: document.getElementById('autocompleteDropdown'),
                
                // Photo and hints
                businessPhoto: document.getElementById('businessPhoto'),
                funFact: document.getElementById('funFact'),
                newHints: document.getElementById('newHints'),
                
                // Map elements
                mapContainer: document.getElementById('mapContainer'),
                map: document.getElementById('map'),
                mapLabel: document.querySelector('.map-label'),
                
                // Multiple choice
                multipleChoiceContainer: document.getElementById('multipleChoiceContainer'),
                choiceGrid: document.getElementById('choiceGrid'),
                
                // Game end
                gameEnd: document.getElementById('gameEnd'),
                resultMessage: document.getElementById('resultMessage'),
                businessNameReveal: document.getElementById('businessNameReveal'),
                businessDetails: document.getElementById('businessDetails'),
                shareButton: document.getElementById('shareButton'),
                countdownTime: document.getElementById('countdownTime'),
                
                // Guesses grid
                guessesGrid: document.getElementById('guessesGrid'),
                
                // Modals
                statsModal: document.getElementById('statsModal'),
                debugModal: document.getElementById('debugModal'),
                tutorialModal: document.getElementById('tutorialModal'),
                whyBizzleModal: document.getElementById('whyBizzleModal'),
                
                // Statistics
                gamesPlayed: document.getElementById('gamesPlayed'),
                winPercentage: document.getElementById('winPercentage'),
                currentStreak: document.getElementById('currentStreak'),
                maxStreak: document.getElementById('maxStreak'),
                totalPoints: document.getElementById('totalPoints'),
                achievementCount: document.getElementById('achievementCount'),
                achievementGrid: document.getElementById('achievementGrid'),
                
                // Debug elements
                debugDay: document.getElementById('debugDay'),
                debugGuesses: document.getElementById('debugGuesses'),
                debugState: document.getElementById('debugState'),
                debugBusiness: document.getElementById('debugBusiness'),

                // Karl the Fog
                karlTheFog: document.getElementById('karlTheFog'),
                karlToggle: document.getElementById('karlToggle')
            };
        }

        let currentBusiness = null;
        let allBusinesses = [];
        let gameState = {
            date: null,
            guesses: [],
            hintsRevealed: 0,
            won: false,
            lost: false,
            statsUpdated: false, // Track if stats were already updated for this game
            phase: 'freeform', // 'freeform' | 'multiple-choice'
            round: 1, // 1-5
            mapZoomLevel: 0,
            multipleChoiceOptions: [],
            correctCoordinates: null,
            pointsEarned: 0 // Points earned this game
        };
        let selectedAutocompleteIndex = -1;
        let map = null;
        let businessMarker = null;

        async function fetchBusinessData() {
            try {
                const cacheKey = 'businessCache';
                const cacheDate = 'businessCacheDate';
                const today = new Date().toDateString();
                
                const cachedDate = localStorage.getItem(cacheDate);
                const cachedData = localStorage.getItem(cacheKey);
                
                if (cachedDate === today && cachedData) {
                    return JSON.parse(cachedData);
                }
                
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${CONFIG.SHEET_RANGE}?key=${CONFIG.API_KEY}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch data from Google Sheets');
                }
                
                const data = await response.json();
                const rows = data.values;
                
                if (!rows || rows.length < 2) {
                    throw new Error('No data found in spreadsheet');
                }
                
                const headers = rows[0];
                const businesses = rows.slice(1).map(row => {
                    const business = {};
                    headers.forEach((header, index) => {
                        business[header] = row[index] || '';
                    });
                    return business;
                });
                
                localStorage.setItem(cacheKey, JSON.stringify(businesses));
                localStorage.setItem(cacheDate, today);
                
                return businesses;
            } catch (error) {
                console.error('Error fetching business data:', error);
                showError('Failed to load today\'s business. Please try refreshing the page.');
                return [];
            }
        }

        function getTodaysBusiness(businesses) {
            // Check for debug date override
            const debugDate = localStorage.getItem('debugDate');
            const targetDate = debugDate || new Date().toISOString().split('T')[0];
            
            // First, check if there's a scheduled business for this specific date
            const scheduledBusiness = businesses.find(b => b.DateToFeature === targetDate);
            if (scheduledBusiness) {
                return scheduledBusiness;
            }
            
            // Otherwise, calculate based on days since epoch (use debug date if available)
            const referenceDate = debugDate ? new Date(debugDate) : new Date();
            const daysSinceEpoch = Math.floor((referenceDate - new Date(CONFIG.GAME_START_DATE)) / (1000 * 60 * 60 * 24));
            const index = daysSinceEpoch % businesses.length;
            return businesses[index];
        }

        function getDayNumber() {
            const startDate = new Date(CONFIG.GAME_START_DATE);
            const debugDate = localStorage.getItem('debugDate');
            const referenceDate = debugDate ? new Date(debugDate) : new Date();
            const daysDiff = Math.floor((referenceDate - startDate) / (1000 * 60 * 60 * 24));
            return Math.max(1, daysDiff + 1);
        }

        /**
         * Geocoding system with localStorage caching and improved error handling
         */
        async function geocodeAddress(address) {
            if (!address || !address.trim()) {
                console.warn('Empty address provided for geocoding');
                return CONFIG.SF_CENTER;
            }
            
            try {
                // Check cache first
                const cacheKey = `coords_${address}`;
                const cached = localStorage.getItem(cacheKey);
                if (cached) {
                    return JSON.parse(cached);
                }
                
                // Try using the Maps JavaScript API Geocoder (works with domain restrictions)
                if (window.google && google.maps && google.maps.Geocoder) {
                    return new Promise((resolve, reject) => {
                        const geocoder = new google.maps.Geocoder();
                        geocoder.geocode({ address: address }, (results, status) => {
                            if (status === 'OK' && results[0]) {
                                const coords = {
                                    lat: results[0].geometry.location.lat(),
                                    lng: results[0].geometry.location.lng()
                                };
                                // Cache for future use
                                localStorage.setItem(cacheKey, JSON.stringify(coords));
                                resolve(coords);
                            } else {
                                console.warn(`Geocoding failed for "${address}": ${status}`);
                                // Try the direct API as fallback
                                geocodeViaAPI(address, cacheKey).then(resolve).catch(() => resolve(CONFIG.SF_CENTER));
                            }
                        });
                    });
                } else {
                    // Fallback to direct API call
                    return geocodeViaAPI(address, cacheKey);
                }
            } catch (error) {
                console.error(`Geocoding error for "${address}":`, error.message);
                return CONFIG.SF_CENTER;
            }
        }

        async function geocodeViaAPI(address, cacheKey) {
            try {
                const encodedAddress = encodeURIComponent(address);
                const response = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodedAddress}&key=${CONFIG.API_KEY}`);
                
                if (!response.ok) {
                    throw new Error(`Geocoding HTTP error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'OK' && data.results.length > 0) {
                    const coords = {
                        lat: data.results[0].geometry.location.lat,
                        lng: data.results[0].geometry.location.lng
                    };
                    
                    // Cache for future use
                    localStorage.setItem(cacheKey, JSON.stringify(coords));
                    return coords;
                } else {
                    console.warn(`Geocoding API failed for "${address}": ${data.status}`);
                    return CONFIG.SF_CENTER;
                }
            } catch (error) {
                console.error(`Geocoding API error for "${address}":`, error.message);
                return CONFIG.SF_CENTER;
            }
        }

        function calculatePoints(guessNumber) {
            const pointsMap = {
                1: CONFIG.POINTS.FIRST_GUESS,
                2: CONFIG.POINTS.SECOND_GUESS,
                3: CONFIG.POINTS.THIRD_GUESS,
                4: CONFIG.POINTS.FOURTH_GUESS,
                5: CONFIG.POINTS.FIFTH_GUESS
            };
            return pointsMap[guessNumber] || CONFIG.POINTS.NO_POINTS;
        }

        function fuzzyMatch(guess, answer) {
            const cleanString = (str) => {
                return str.toLowerCase()
                    .replace(/^(the|a|an)\s+/i, '')
                    .replace(/\s*(san francisco|sf)\s*/gi, '')
                    .replace(/[^a-z0-9]/g, '');
            };
            
            const cleanGuess = cleanString(guess);
            const cleanAnswer = cleanString(answer);
            
            if (cleanGuess === cleanAnswer) return true;
            
            const longer = cleanGuess.length > cleanAnswer.length ? cleanGuess : cleanAnswer;
            const shorter = cleanGuess.length > cleanAnswer.length ? cleanAnswer : cleanGuess;
            
            let matches = 0;
            for (let i = 0; i < shorter.length; i++) {
                if (shorter[i] === longer[i]) matches++;
            }
            
            return matches / longer.length >= CONFIG.FUZZY_MATCH_THRESHOLD;
        }

        function initializeGame() {
            const today = new Date().toDateString();
            const savedState = localStorage.getItem('gameState');
            const lastPlayed = localStorage.getItem('lastPlayed');
            
            if (savedState && lastPlayed === today) {
                gameState = JSON.parse(savedState);
                // Don't restore UI here - wait until business is loaded
            } else {
                gameState = {
                    date: today,
                    guesses: [],
                    hintsRevealed: 0,
                    won: false,
                    lost: false,
                    statsUpdated: false,
                    phase: 'freeform',
                    round: 1,
                    mapZoomLevel: 0,
                    multipleChoiceOptions: [],
                    correctCoordinates: null,
                    pointsEarned: 0
                };
                saveGameState();
            }
            
            domElements.gameNumber.textContent = `Bizzle #${getDayNumber()}`;
            updateGuessCounter();
        }

        function saveGameState() {
            localStorage.setItem('gameState', JSON.stringify(gameState));
            localStorage.setItem('lastPlayed', new Date().toDateString());
        }

        function restoreGameUI() {
            // Safety checks for required elements
            const guessSection = document.getElementById('guessSection');
            const guessesGrid = document.getElementById('guessesGrid');
            const hintsContainer = document.getElementById('newHints');
            const header = document.querySelector('header');
            
            if (!guessSection || !guessesGrid || !hintsContainer) {
                console.error('Required elements not found during UI restore');
                return;
            }
            
            // Hide header if hints have been revealed (gameplay started)
            if (gameState.hintsRevealed > 0 && header) {
                header.classList.add('hidden');
            }
            
            // Handle different game phases
            if (gameState.won || gameState.lost) {
                // Game complete
                guessSection.style.display = 'none';
                // Hide hints section to avoid redundancy with business details
                hintsContainer.style.display = 'none';
                hideMultipleChoice();
                if (gameState.correctCoordinates) {
                    showMap();
                    showFinalLocation(); // Show exact location with marker
                }
                guessesGrid.style.display = 'block';
                endGame(gameState.won);
            } else if (gameState.phase === 'multiple-choice') {
                // In multiple choice phase
                guessSection.style.display = 'none';
                showMap();
                if (gameState.correctCoordinates) {
                    // Use current round for zoom level (progressive zooming)
                    const currentZoomLevel = gameState.round;
                    console.log(`Restoring map zoom to level ${currentZoomLevel} for round ${gameState.round}`);
                    updateMapZoom(currentZoomLevel, gameState.correctCoordinates);
                }
                if (gameState.multipleChoiceOptions.length > 0) {
                    showMultipleChoice(gameState.multipleChoiceOptions);
                }
            } else {
                // Free-form phase
                updateGuessCounter();
                hideMap();
                hideMultipleChoice();
            }
            
            // Recreate guess slots for existing guesses
            gameState.guesses.forEach((guess, index) => {
                addGuessSlot(guess.text, guess.correct);
            });
            
            // Clear any existing hints and recreate them in reverse order (newest first)
            hintsContainer.innerHTML = '';
            
            // Reveal hints in reverse order so newest appears at top
            for (let i = gameState.hintsRevealed; i >= 1; i--) {
                revealHint(i);
            }
        }

        function revealHint(hintNumber) {
            const hintsContainer = domElements.newHints;
            
            // Don't try to reveal hints if business isn't loaded yet
            if (!currentBusiness) {
                console.warn('Cannot reveal hint: business not loaded yet');
                return;
            }
            
            // Get hint configuration from CONFIG
            const hintConfig = CONFIG.HINTS[hintNumber];
            if (!hintConfig) return;
            
            const hint = {
                label: hintConfig.label,
                content: currentBusiness[hintConfig.field]
            };
            
            // Check if hint already exists to avoid duplicates
            if (document.getElementById(`hint${hintNumber}`)) {
                return;
            }
            
            // Create new hint element
            const hintElement = document.createElement('div');
            hintElement.className = 'hint';
            hintElement.id = `hint${hintNumber}`;
            hintElement.innerHTML = `
                <div class="hint-label">${hint.label}</div>
                <div>${hint.content}</div>
            `;
            
            // Add it to the TOP of the hints container (prepend)
            hintsContainer.prepend(hintElement);
            
            // Hide header when first hint is revealed (gameplay starts)
            if (hintNumber === 1) {
                const header = document.querySelector('header');
                if (header) {
                    header.classList.add('hidden');
                }
            }
            
            // Trigger animation after DOM insertion
            requestAnimationFrame(() => {
                hintElement.classList.add('revealed');
            });
        }

        function addGuessSlot(guessText, isCorrect) {
            const guessesGrid = document.getElementById('guessesGrid');
            const guessSlot = document.createElement('div');
            guessSlot.className = 'guess-slot';
            guessSlot.textContent = guessText;
            
            if (isCorrect) {
                guessSlot.classList.add('correct');
            } else {
                guessSlot.classList.add('wrong');
            }
            
            guessesGrid.appendChild(guessSlot);
            // Don't show during gameplay - only at the end
        }

        function updateGuessCounter() {
            const counter = domElements.guessCounter;
            
            // Safety check - if counter doesn't exist (game might be complete), skip update
            if (!counter) {
                return;
            }
            
            const remaining = CONFIG.MAX_GUESSES - gameState.guesses.length;
            
            if (gameState.won) {
                counter.textContent = `Solved in ${gameState.guesses.length} guess${gameState.guesses.length === 1 ? '' : 'es'}!`;
                counter.className = 'guess-counter';
            } else if (gameState.lost) {
                counter.textContent = 'No guesses remaining';
                counter.className = 'guess-counter danger';
            } else {
                counter.textContent = `${remaining} guess${remaining === 1 ? '' : 'es'} remaining`;
                
                if (remaining <= 1) {
                    counter.className = 'guess-counter danger';
                } else if (remaining <= 2) {
                    counter.className = 'guess-counter warning';
                } else {
                    counter.className = 'guess-counter';
                }
            }
        }

        function giveUp() {
            if (gameState.won || gameState.lost) return;
            
            if (confirm('Are you sure you want to give up and see the answer?')) {
                gameState.lost = true;
                gameState.gaveUp = true; // Track that they gave up vs ran out of guesses
                
                // Reveal all remaining hints in reverse order (newest first)
                for (let i = 4; i >= 1; i--) {
                    if (i > gameState.hintsRevealed) {
                        revealHint(i);
                    }
                }
                gameState.hintsRevealed = 4;
                
                // Show final map state with marker
                if (gameState.correctCoordinates) {
                    showMap();
                    updateMapZoom(4, gameState.correctCoordinates);
                }
                
                updateGuessCounter();
                endGame(false);
                saveGameState();
            }
        }

        function skipToMultipleChoice() {
            if (gameState.won || gameState.lost) return;
            
            // Add the first guess as incorrect to trigger map phase
            const fakeGuess = {
                text: "‚Üí Skipped to Map",
                correct: false
            };
            gameState.guesses.push(fakeGuess);
            
            // Reveal the first hint (neighborhood) and hide header like a normal wrong guess
            if (gameState.hintsRevealed === 0) {
                revealHint(1);
                gameState.hintsRevealed = 1;
            }
            
            // Set phase and round exactly like a normal wrong guess
            gameState.phase = 'multiple-choice';
            gameState.round = 2;
            
            // Transition to multiple choice phase
            transitionToMultipleChoice();
            
            // Update counter and save state
            updateGuessCounter();
            saveGameState();
        }

        function submitGuess() {
            const input = domElements.guessInput;
            const guess = input.value.trim();
            
            if (!guess || gameState.won || gameState.lost) return;
            
            const isCorrect = fuzzyMatch(guess, currentBusiness.Name);
            
            gameState.guesses.push({
                text: guess,
                correct: isCorrect
            });
            
            addGuessSlot(guess, isCorrect);
            updateGuessCounter();
            
            if (isCorrect) {
                gameState.won = true;
                gameState.pointsEarned = calculatePoints(gameState.guesses.length);
                karlCelebrate(); // Karl celebrates the win!
                endGame(true);
            } else {
                // Transition to multiple choice mode after first wrong guess
                gameState.phase = 'multiple-choice';
                gameState.round = 2;
                transitionToMultipleChoice();
            }
            
            saveGameState();
            input.value = '';
            closeAutocomplete();
        }

        async function transitionToMultipleChoice() {
            try {
                // Hide the free-form guess section
                domElements.guessSection.style.display = 'none';
                
                // Show the map with initial SF-wide view
                showMap();
                
                // Ensure coordinates are available
                if (!gameState.correctCoordinates) {
                    gameState.correctCoordinates = await geocodeAddress(currentBusiness.Address);
                }
                
                // Start with SF-wide view (zoom level 1) before first multiple choice round
                updateMapZoom(1, gameState.correctCoordinates);
                
                // Wait a moment for map to settle, then start first multiple choice round
                setTimeout(() => {
                    progressToNextRound();
                }, CONFIG.TIMEOUTS.MAP_SETTLE);
                
            } catch (error) {
                console.error('Error transitioning to multiple choice:', error);
                // Continue with fallback behavior
                showMap();
                setTimeout(() => {
                    progressToNextRound();
                }, CONFIG.TIMEOUTS.MAP_SETTLE);
            }
        }

        /**
         * Update map label with loading or completion status
         */
        function updateMapLabel(config, isLoading = false) {
            const mapLabel = domElements.mapLabel;
            if (!mapLabel) return;
            
            if (isLoading) {
                mapLabel.textContent = `üó∫Ô∏è Loading ${config.label.toLowerCase()} options...`;
            } else {
                mapLabel.textContent = `üó∫Ô∏è ${config.label} - Round ${gameState.round}`;
            }
        }
        
        /**
         * Limit multiple choice options based on round configuration
         */
        function limitMultipleChoiceOptions(options, config) {
            if (options.length <= config.maxOptions) {
                return options;
            }
            
            const correctAnswer = currentBusiness.Name;
            const otherOptions = options.filter(opt => opt !== correctAnswer);
            const limitedOthers = shuffleArray(otherOptions).slice(0, config.maxOptions - 1);
            return shuffleArray([...limitedOthers, correctAnswer]);
        }
        
        /**
         * Reveal the appropriate hint for the current round
         */
        function revealRoundHint() {
            const hintMap = { 2: 1, 3: 2, 4: 3 }; // Round to hint number mapping
            const hintNumber = hintMap[gameState.round];
            
            if (hintNumber && hintNumber <= 4) {
                revealHint(hintNumber);
                gameState.hintsRevealed = Math.max(gameState.hintsRevealed, hintNumber);
            }
        }
        
        async function progressToNextRound() {
            try {
                // Update map zoom based on current round (progressive zoom)
                updateMapZoom(gameState.round, gameState.correctCoordinates);
                
                // Get round configuration from CONFIG
                const config = CONFIG.ROUNDS[gameState.round] || CONFIG.ROUNDS[2];
                
                // Update map label with loading state
                updateMapLabel(config, true);
                
                // Generate multiple choice options
                let options = await generateMultipleChoice(
                    currentBusiness.Category, 
                    gameState.correctCoordinates, 
                    config.radius
                );
                
                // Limit options based on round configuration
                options = limitMultipleChoiceOptions(options, config);
                gameState.multipleChoiceOptions = options;
                
                // Update map label to show ready state
                updateMapLabel(config, false);
                
                // Show multiple choice UI
                showMultipleChoice(options);
                
            } catch (error) {
                console.error(`Error in round ${gameState.round}:`, error.message);
                
                // Fallback to basic options
                const config = CONFIG.ROUNDS[gameState.round] || CONFIG.ROUNDS[2];
                const fallbackOptions = generateFallbackOptions();
                gameState.multipleChoiceOptions = fallbackOptions;
                
                updateMapLabel(config, false);
                showMultipleChoice(fallbackOptions);
            }
            
            // Reveal appropriate hint for this round
            revealRoundHint();
        }

        function endGame(won) {
            // Hide the multiple choice interface
            hideMultipleChoice();
            
            // Hide the hints section to avoid redundancy with business details
            if (domElements.newHints) {
                domElements.newHints.style.display = 'none';
            }
            
            // Show the guess history now that game is over
            if (gameState.guesses.length > 0) {
                domElements.guessesGrid.style.display = 'block';
            }
            
            const gameEnd = domElements.gameEnd;
            const resultMessage = domElements.resultMessage;
            const businessNameReveal = domElements.businessNameReveal;
            const businessDetails = domElements.businessDetails;
            
            if (!gameEnd) {
                console.error('Game end element not found');
                return;
            }
            
            // Make game end section visible
            gameEnd.style.display = 'block';
            gameEnd.style.visibility = 'visible';
            gameEnd.style.opacity = '1';
            gameEnd.classList.add('show');
            
            // Scroll to game end section
            setTimeout(() => {
                gameEnd.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
            
            if (won) {
                resultMessage.textContent = `üéâ Amazing! Got it in ${gameState.guesses.length} ${gameState.guesses.length === 1 ? 'guess' : 'guesses'}! (+${gameState.pointsEarned} points)`;
                resultMessage.className = 'result-message win';
            } else {
                if (gameState.gaveUp) {
                    resultMessage.textContent = 'No worries! Now you know for next time!';
                } else {
                    resultMessage.textContent = 'Better luck tomorrow!';
                }
                resultMessage.className = 'result-message lose';
            }
            
            businessNameReveal.textContent = currentBusiness.Name;
            
            // Check if business has been visited
            const achievements = getAchievementData();
            const businessId = currentBusiness.Name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
            const isVisited = achievements.visitedBusinesses.includes(businessId);
            
            
            businessDetails.innerHTML = `
                <div class="business-info">
                    <p><strong>Address:</strong> ${currentBusiness.Address}</p>
                    <p><strong>Neighborhood:</strong> ${currentBusiness.Neighborhood}</p>
                    <p><strong>Category:</strong> ${currentBusiness.Category}</p>
                    <p><strong>Signature:</strong> ${currentBusiness.Signature}</p>
                    ${currentBusiness.Website ? `<p><strong>Website:</strong> <a href="${currentBusiness.Website}" target="_blank">${currentBusiness.Website}</a></p>` : ''}
                </div>
                
                
                <div class="visit-actions">
                    ${!isVisited ? `
                        <button class="visit-button" onclick="markAsVisited('${businessId}')">
                            üìç I Went Here! (+${CONFIG.VISIT_BONUS} bonus points)
                        </button>
                        <button class="wishlist-button" onclick="addToWishlist('${businessId}')">
                            üí≠ Want to Visit
                        </button>
                    ` : `
                        <div class="visited-badge">‚úÖ You've been here!</div>
                    `}
                    <a href="https://maps.google.com/?q=${encodeURIComponent(currentBusiness.Name + ', ' + currentBusiness.Address)}" target="_blank" class="directions-button">
                        üó∫Ô∏è Get Directions
                    </a>
                </div>
            `;
            
            // Only update statistics once per game
            if (!gameState.statsUpdated) {
                updateStatistics(won);
                gameState.statsUpdated = true;
                saveGameState();
            }
            startCountdown();
        }

        function generateShareText() {
            const dayNumber = getDayNumber();
            const guessCount = gameState.won ? gameState.guesses.length : 'X';
            let emojiGrid = '';
            
            for (let i = 0; i < 5; i++) {
                if (i < gameState.guesses.length) {
                    emojiGrid += gameState.guesses[i].correct ? 'üü©' : 'üü•';
                } else {
                    emojiGrid += '‚¨ú';
                }
            }
            
            // Add achievements and stats to share text
            const stats = JSON.parse(localStorage.getItem('statistics') || '{"totalPoints":0,"gamesWon":0}');
            const achievements = getAchievementData();
            
            let shareText = `Bizzle #${dayNumber} ${guessCount}/5`;
            
            if (gameState.pointsEarned > 0) {
                shareText += ` (+${gameState.pointsEarned} points)`;
            }
            
            shareText += `\n${emojiGrid}`;
            
            // Add achievement unlock if any new achievements were unlocked today
            if (gameState.won && achievements.unlocked.length > 0) {
                const recentAchievement = achievements.unlocked[achievements.unlocked.length - 1];
                const achievement = CONFIG.ACHIEVEMENTS[recentAchievement];
                if (achievement && gameState.pointsEarned === 5 && recentAchievement === 'perfect') {
                    shareText += `\nüèÜ Achievement Unlocked: ${achievement.name}!`;
                }
            }
            
            shareText += `\nüíØ Total: ${stats.totalPoints} pts | üèÜ ${achievements.unlocked.length} achievements`;
            
            const url = window.location.href.split('?')[0];
            shareText += `\n\nDiscover SF businesses at ${url}`;
            
            return shareText;
        }

        function shareResult() {
            const shareText = generateShareText();
            const shareButton = document.getElementById('shareButton');
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareText).then(() => {
                    shareButton.textContent = 'Copied!';
                    shareButton.classList.add('copied');
                    setTimeout(() => {
                        shareButton.textContent = 'Share Result';
                        shareButton.classList.remove('copied');
                    }, 2000);
                }).catch(() => {
                    fallbackCopy(shareText);
                });
            } else {
                fallbackCopy(shareText);
            }
        }

        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            
            const shareButton = document.getElementById('shareButton');
            shareButton.textContent = 'Copied!';
            shareButton.classList.add('copied');
            setTimeout(() => {
                shareButton.textContent = 'Share Result';
                shareButton.classList.remove('copied');
            }, 2000);
        }

        function updateStatistics(won) {
            let stats = localStorage.getItem('statistics');
            if (!stats) {
                stats = {
                    gamesPlayed: 0,
                    gamesWon: 0,
                    currentStreak: 0,
                    maxStreak: 0,
                    totalPoints: 0
                };
            } else {
                stats = JSON.parse(stats);
                // Add totalPoints to existing stats if not present
                if (typeof stats.totalPoints === 'undefined') {
                    stats.totalPoints = 0;
                }
            }
            
            stats.gamesPlayed++;
            if (won) {
                stats.gamesWon++;
                stats.currentStreak++;
                stats.totalPoints += gameState.pointsEarned;
                if (stats.currentStreak > stats.maxStreak) {
                    stats.maxStreak = stats.currentStreak;
                }
            } else {
                stats.currentStreak = 0;
            }
            
            localStorage.setItem('statistics', JSON.stringify(stats));
            
            // Check for new achievements after updating stats
            checkAchievements(stats, won);
        }
        
        /**
         * Achievement System Functions
         */
        function getAchievementData() {
            let data = localStorage.getItem('achievements');
            if (!data) {
                data = {
                    unlocked: [],
                    progress: {},
                    visitedBusinesses: [],
                    lightningCount: 0 // Track 4+ point games for lightning achievement
                };
            } else {
                data = JSON.parse(data);
            }
            return data;
        }
        
        function saveAchievementData(data) {
            localStorage.setItem('achievements', JSON.stringify(data));
        }
        
        function checkAchievements(stats, won) {
            const achievements = getAchievementData();
            const newAchievements = [];
            
            // Check streak achievements
            if (stats.currentStreak >= 3 && !achievements.unlocked.includes('streak_3')) {
                newAchievements.push('streak_3');
            }
            if (stats.currentStreak >= 7 && !achievements.unlocked.includes('streak_7')) {
                newAchievements.push('streak_7');
            }
            if (stats.currentStreak >= 15 && !achievements.unlocked.includes('streak_15')) {
                newAchievements.push('streak_15');
            }
            if (stats.currentStreak >= 30 && !achievements.unlocked.includes('streak_30')) {
                newAchievements.push('streak_30');
            }
            
            // Check score achievements
            if (gameState.pointsEarned === 5 && !achievements.unlocked.includes('perfect')) {
                newAchievements.push('perfect');
            }
            if (gameState.pointsEarned >= 4) {
                achievements.lightningCount = (achievements.lightningCount || 0) + 1;
                if (achievements.lightningCount >= 5 && !achievements.unlocked.includes('lightning')) {
                    newAchievements.push('lightning');
                }
            }
            if (stats.totalPoints >= 100 && !achievements.unlocked.includes('centurion')) {
                newAchievements.push('centurion');
            }
            
            // Check discovery achievements
            if (won) {
                if (stats.gamesWon === 1 && !achievements.unlocked.includes('first_timer')) {
                    newAchievements.push('first_timer');
                }
                if (stats.gamesWon >= 10 && !achievements.unlocked.includes('explorer')) {
                    newAchievements.push('explorer');
                }
                if (stats.gamesWon >= 25 && !achievements.unlocked.includes('local_expert')) {
                    newAchievements.push('local_expert');
                }
            }
            
            // Check visit achievements
            const visitCount = achievements.visitedBusinesses.length;
            if (visitCount >= 1 && !achievements.unlocked.includes('adventurer')) {
                newAchievements.push('adventurer');
            }
            if (visitCount >= 5 && !achievements.unlocked.includes('foodie')) {
                newAchievements.push('foodie');
            }
            if (visitCount >= 15 && !achievements.unlocked.includes('local_legend')) {
                newAchievements.push('local_legend');
            }
            
            // Add new achievements and show notifications
            if (newAchievements.length > 0) {
                achievements.unlocked = [...achievements.unlocked, ...newAchievements];
                saveAchievementData(achievements);
                showAchievementNotifications(newAchievements);
            }
        }
        
        function showAchievementNotifications(achievementIds) {
            achievementIds.forEach((id, index) => {
                setTimeout(() => {
                    const achievement = CONFIG.ACHIEVEMENTS[id];
                    showAchievementPopup(achievement);
                }, index * 1000); // Stagger notifications
            });
        }
        
        function showAchievementPopup(achievement) {
            karlCelebrate(); // Karl celebrates achievements too!
            
            // Create achievement notification popup
            const popup = document.createElement('div');
            popup.className = 'achievement-popup';
            popup.innerHTML = `
                <div class="achievement-content">
                    <div class="achievement-emoji">${achievement.emoji}</div>
                    <div class="achievement-text">
                        <div class="achievement-title">Achievement Unlocked!</div>
                        <div class="achievement-name">${achievement.name}</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            // Animate in
            setTimeout(() => {
                popup.classList.add('show');
            }, 100);
            
            // Remove after 4 seconds
            setTimeout(() => {
                popup.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(popup);
                }, 500);
            }, 4000);
        }

        function displayStatistics() {
            let stats = localStorage.getItem('statistics');
            if (!stats) {
                stats = {
                    gamesPlayed: 0,
                    gamesWon: 0,
                    currentStreak: 0,
                    maxStreak: 0,
                    totalPoints: 0
                };
            } else {
                stats = JSON.parse(stats);
                // Add totalPoints to existing stats if not present
                if (typeof stats.totalPoints === 'undefined') {
                    stats.totalPoints = 0;
                }
            }
            
            domElements.gamesPlayed.textContent = stats.gamesPlayed;
            domElements.winPercentage.textContent = 
                stats.gamesPlayed > 0 
                    ? Math.round((stats.gamesWon / stats.gamesPlayed) * 100) + '%'
                    : '0%';
            domElements.currentStreak.textContent = stats.currentStreak;
            domElements.maxStreak.textContent = stats.maxStreak;
            domElements.totalPoints.textContent = stats.totalPoints;
            
            // Display achievements
            displayAchievements();
        }
        
        function displayAchievements() {
            const achievements = getAchievementData();
            const achievementGrid = domElements.achievementGrid;
            
            // Update achievement count
            domElements.achievementCount.textContent = achievements.unlocked.length;
            
            // Clear existing achievement badges
            achievementGrid.innerHTML = '';
            
            // Create achievement badges for all achievements
            Object.keys(CONFIG.ACHIEVEMENTS).forEach(achievementId => {
                const achievement = CONFIG.ACHIEVEMENTS[achievementId];
                const isUnlocked = achievements.unlocked.includes(achievementId);
                
                const badge = document.createElement('div');
                badge.className = `achievement-badge ${isUnlocked ? 'unlocked' : 'locked'}`;
                badge.title = achievement.description;
                badge.innerHTML = `
                    <span class="achievement-badge-emoji">${achievement.emoji}</span>
                    <div class="achievement-badge-name">${achievement.name}</div>
                `;
                
                achievementGrid.appendChild(badge);
            });
        }
        
        /**
         * Visit Tracking Functions
         */
        function markAsVisited(businessId) {
            const achievements = getAchievementData();
            
            if (!achievements.visitedBusinesses.includes(businessId)) {
                // Add to visited businesses
                achievements.visitedBusinesses.push(businessId);
                
                // Add bonus points to current game stats
                const stats = JSON.parse(localStorage.getItem('statistics') || '{}');
                stats.totalPoints = (stats.totalPoints || 0) + CONFIG.VISIT_BONUS;
                localStorage.setItem('statistics', JSON.stringify(stats));
                
                // Save achievement data
                saveAchievementData(achievements);
                
                // Check for visit-related achievements
                const visitCount = achievements.visitedBusinesses.length;
                const newAchievements = [];
                
                if (visitCount >= 1 && !achievements.unlocked.includes('adventurer')) {
                    newAchievements.push('adventurer');
                }
                if (visitCount >= 5 && !achievements.unlocked.includes('foodie')) {
                    newAchievements.push('foodie');
                }
                if (visitCount >= 15 && !achievements.unlocked.includes('local_legend')) {
                    newAchievements.push('local_legend');
                }
                
                if (newAchievements.length > 0) {
                    achievements.unlocked = [...achievements.unlocked, ...newAchievements];
                    saveAchievementData(achievements);
                    showAchievementNotifications(newAchievements);
                }
                
                // Update the UI to show visited status
                updateVisitUI(businessId, true);
                
                // Show bonus notification
                showVisitBonus();
            }
        }
        
        function addToWishlist(businessId) {
            let wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
            
            if (!wishlist.includes(businessId)) {
                wishlist.push(businessId);
                localStorage.setItem('wishlist', JSON.stringify(wishlist));
                
                // Show confirmation
                const wishlistButton = document.querySelector('.wishlist-button');
                const originalText = wishlistButton.innerHTML;
                wishlistButton.innerHTML = '‚úÖ Added to wishlist!';
                wishlistButton.style.pointerEvents = 'none';
                
                setTimeout(() => {
                    wishlistButton.innerHTML = originalText;
                    wishlistButton.style.pointerEvents = 'auto';
                }, 2000);
            }
        }
        
        function updateVisitUI(businessId, isVisited) {
            const visitActions = document.querySelector('.visit-actions');
            if (visitActions && isVisited) {
                const visitButton = visitActions.querySelector('.visit-button');
                const wishlistButton = visitActions.querySelector('.wishlist-button');
                
                if (visitButton) visitButton.remove();
                if (wishlistButton) wishlistButton.remove();
                
                // Add visited badge
                const visitedBadge = document.createElement('div');
                visitedBadge.className = 'visited-badge';
                visitedBadge.textContent = '‚úÖ You\'ve been here!';
                visitActions.insertBefore(visitedBadge, visitActions.firstChild);
            }
        }
        
        function showVisitBonus() {
            const bonusPopup = document.createElement('div');
            bonusPopup.className = 'achievement-popup visit-bonus';
            bonusPopup.innerHTML = `
                <div class="achievement-content">
                    <div class="achievement-emoji">üéâ</div>
                    <div class="achievement-text">
                        <div class="achievement-title">Bonus Points!</div>
                        <div class="achievement-name">+${CONFIG.VISIT_BONUS} for visiting!</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(bonusPopup);
            
            // Animate in
            setTimeout(() => {
                bonusPopup.classList.add('show');
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                bonusPopup.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(bonusPopup)) {
                        document.body.removeChild(bonusPopup);
                    }
                }, 500);
            }, 3000);
        }
        
        /**
         * Discovery Content Generation
         */

        function showStats() {
            displayStatistics();
            domElements.statsModal.classList.add('show');
        }

        function closeStats() {
            domElements.statsModal.classList.remove('show');
        }

        function showDebug() {
            updateDebugInfo();
            
            // Initialize date picker with current debug date or today
            const dateInput = document.getElementById('debugDatePicker');
            const debugDate = localStorage.getItem('debugDate');
            if (debugDate) {
                dateInput.value = debugDate;
            } else {
                dateInput.value = new Date().toISOString().split('T')[0];
            }
            
            domElements.debugModal.classList.add('show');
        }

        function closeDebug() {
            domElements.debugModal.classList.remove('show');
        }

        function showTutorial() {
            domElements.tutorialModal.classList.add('show');
        }

        function closeTutorial() {
            domElements.tutorialModal.classList.remove('show');
            // Mark tutorial as seen
            localStorage.setItem('tutorialSeen', 'true');
        }

        function showWhyBizzle() {
            domElements.whyBizzleModal.classList.add('show');
        }

        function closeWhyBizzle() {
            domElements.whyBizzleModal.classList.remove('show');
        }

        /**
         * Karl the Fog Animation System
         */
        let karlAnimation = {
            x: 100,
            y: 100,
            targetX: 100,
            targetY: 100,
            speed: 0.02,
            changeDirection: 0,
            enabled: true,
            animationId: null,
            directionInterval: null
        };

        function initializeKarl() {
            if (!domElements.karlTheFog) return;

            // Check if Karl is enabled from localStorage (default: false)
            const karlEnabled = localStorage.getItem('karlEnabled');
            karlAnimation.enabled = karlEnabled === null ? false : karlEnabled === 'true';
            
            updateKarlToggleUI();

            if (karlAnimation.enabled) {
                // Start Karl in a random position
                karlAnimation.x = Math.random() * (window.innerWidth - 100);
                karlAnimation.y = Math.random() * (window.innerHeight - 100);
                
                updateKarlPosition();
                startKarlMovement();
            } else {
                hideKarl();
            }
        }

        function startKarlMovement() {
            if (!karlAnimation.enabled) return;

            // Start movement animation
            karlAnimation.animationId = setInterval(() => {
                moveKarl();
            }, 16); // ~60fps

            // Change direction every 5-10 seconds
            karlAnimation.directionInterval = setInterval(() => {
                setNewKarlTarget();
            }, 5000 + Math.random() * 5000);
        }

        function stopKarlMovement() {
            if (karlAnimation.animationId) {
                clearInterval(karlAnimation.animationId);
                karlAnimation.animationId = null;
            }
            if (karlAnimation.directionInterval) {
                clearInterval(karlAnimation.directionInterval);
                karlAnimation.directionInterval = null;
            }
        }

        function setNewKarlTarget() {
            const margin = 100;
            karlAnimation.targetX = margin + Math.random() * (window.innerWidth - margin * 2);
            karlAnimation.targetY = margin + Math.random() * (window.innerHeight - margin * 2);
        }

        function moveKarl() {
            // Smooth movement toward target
            const dx = karlAnimation.targetX - karlAnimation.x;
            const dy = karlAnimation.targetY - karlAnimation.y;
            
            karlAnimation.x += dx * karlAnimation.speed;
            karlAnimation.y += dy * karlAnimation.speed;
            
            updateKarlPosition();
        }

        function updateKarlPosition() {
            if (!domElements.karlTheFog) return;
            
            domElements.karlTheFog.style.left = karlAnimation.x + 'px';
            domElements.karlTheFog.style.top = karlAnimation.y + 'px';
        }

        // Special Karl reactions to game events
        function karlCelebrate() {
            if (!domElements.karlTheFog || !karlAnimation.enabled) return;
            
            // Temporarily increase opacity and add celebration animation
            domElements.karlTheFog.style.opacity = '0.6';
            domElements.karlTheFog.style.animation = 'karl-drift 2s ease-in-out';
            
            // Reset after celebration
            setTimeout(() => {
                domElements.karlTheFog.style.opacity = '0.3';
                domElements.karlTheFog.style.animation = '';
            }, 2000);
        }

        // Karl toggle functionality
        function toggleKarl() {
            karlAnimation.enabled = !karlAnimation.enabled;
            localStorage.setItem('karlEnabled', karlAnimation.enabled.toString());
            
            if (karlAnimation.enabled) {
                showKarl();
                startKarlMovement();
            } else {
                stopKarlMovement();
                hideKarl();
            }
            
            updateKarlToggleUI();
        }

        function showKarl() {
            if (!domElements.karlTheFog) return;
            domElements.karlTheFog.style.display = 'block';
        }

        function hideKarl() {
            if (!domElements.karlTheFog) return;
            domElements.karlTheFog.style.display = 'none';
        }

        function updateKarlToggleUI() {
            if (!domElements.karlToggle) return;
            
            if (karlAnimation.enabled) {
                domElements.karlToggle.classList.remove('karl-disabled');
                domElements.karlToggle.title = 'Hide Karl the Fog';
            } else {
                domElements.karlToggle.classList.add('karl-disabled');
                domElements.karlToggle.title = 'Show Karl the Fog';
            }
        }

        // Update Karl position on window resize
        window.addEventListener('resize', () => {
            if (karlAnimation.targetX > window.innerWidth - 100) {
                setNewKarlTarget();
            }
        });

        function updateDebugInfo() {
            const debugDate = localStorage.getItem('debugDate');
            const dayNumber = getDayNumber();
            
            // Show debug date indicator if active
            if (debugDate) {
                domElements.debugDay.textContent = `${dayNumber} üß™ (${debugDate})`;
            } else {
                domElements.debugDay.textContent = dayNumber;
            }
            
            domElements.debugGuesses.textContent = gameState.guesses.length;
            
            let state = 'Active';
            if (gameState.won) state = 'Won';
            else if (gameState.lost) state = 'Lost';
            domElements.debugState.textContent = state;
            
            domElements.debugBusiness.textContent = currentBusiness ? currentBusiness.Name : 'Not loaded';
        }

        function clearTodaysGame() {
            if (confirm('Clear today\'s game progress? This will reset your current game.')) {
                localStorage.removeItem('gameState');
                localStorage.removeItem('lastPlayed');
                location.reload();
            }
        }

        function clearAllStats() {
            if (confirm('Clear all statistics? This cannot be undone.')) {
                localStorage.removeItem('statistics');
                alert('Statistics cleared!');
                closeDebug();
            }
        }

        function clearBusinessCache() {
            if (confirm('Clear business data cache? This will force a fresh download.')) {
                localStorage.removeItem('businessCache');
                localStorage.removeItem('businessCacheDate');
                alert('Cache cleared! Refresh to reload data.');
            }
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è DANGER: Clear ALL data? This includes game progress, statistics, and cache. This cannot be undone!')) {
                if (confirm('Are you absolutely sure? This will delete everything!')) {
                    localStorage.clear();
                    alert('All data cleared!');
                    location.reload();
                }
            }
        }

        function loadDateForTesting() {
            const dateInput = document.getElementById('debugDatePicker');
            const selectedDate = dateInput.value;
            
            if (!selectedDate) {
                alert('Please select a date first!');
                return;
            }
            
            // Store the debug date in localStorage
            localStorage.setItem('debugDate', selectedDate);
            
            // Clear current game state to force reload with new date
            localStorage.removeItem('gameState');
            localStorage.removeItem('lastPlayed');
            
            alert(`Loading business for ${selectedDate}...`);
            location.reload();
        }

        function resetToToday() {
            if (confirm('Reset to today\'s business and clear debug date override?')) {
                localStorage.removeItem('debugDate');
                localStorage.removeItem('gameState');
                localStorage.removeItem('lastPlayed');
                location.reload();
            }
        }

        function testPlacesAPI() {
            if (!gameState.correctCoordinates) {
                alert('No coordinates available. Start a game first.');
                return;
            }
            
            console.log('Testing location-aware options with coordinates:', gameState.correctCoordinates);
            console.log('Business type:', currentBusiness?.Category);
            
            fetchPlacesOptions(currentBusiness?.Category || 'Restaurant', gameState.correctCoordinates, 2)
                .then(results => {
                    console.log('Generated Options:', results);
                    const names = results.map(r => r.name || r);
                    alert(`Generated ${results.length} options:\n${names.join('\n')}`);
                })
                .catch(error => {
                    console.error('Option generation failed:', error);
                    alert('Option generation failed. Check console for details.');
                });
        }

        function startCountdown() {
            function updateCountdown() {
                const now = new Date();
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0);
                
                const diff = tomorrow - now;
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                domElements.countdownTime.textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            updateCountdown();
            setInterval(updateCountdown, 1000);
        }

        function setupAutocomplete() {
            const input = document.getElementById('guessInput');
            const dropdown = document.getElementById('autocompleteDropdown');
            
            input.addEventListener('input', (e) => {
                const value = e.target.value.toLowerCase().trim();
                if (value.length < 2) {
                    closeAutocomplete();
                    return;
                }
                
                const matches = allBusinesses.filter(business => 
                    business.Name.toLowerCase().includes(value)
                ).slice(0, 5);
                
                if (matches.length === 0) {
                    closeAutocomplete();
                    return;
                }
                
                dropdown.innerHTML = '';
                selectedAutocompleteIndex = -1;
                
                matches.forEach((business, index) => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.textContent = business.Name;
                    item.addEventListener('click', () => {
                        input.value = business.Name;
                        closeAutocomplete();
                        submitGuess();
                    });
                    dropdown.appendChild(item);
                });
                
                dropdown.classList.add('active');
            });
            
            input.addEventListener('keydown', (e) => {
                const items = dropdown.querySelectorAll('.autocomplete-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedAutocompleteIndex = Math.min(selectedAutocompleteIndex + 1, items.length - 1);
                    updateAutocompleteSelection(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedAutocompleteIndex = Math.max(selectedAutocompleteIndex - 1, -1);
                    updateAutocompleteSelection(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (selectedAutocompleteIndex >= 0 && items[selectedAutocompleteIndex]) {
                        input.value = items[selectedAutocompleteIndex].textContent;
                        closeAutocomplete();
                    }
                    submitGuess();
                } else if (e.key === 'Escape') {
                    closeAutocomplete();
                }
            });
            
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    closeAutocomplete();
                }
            });
        }

        function updateAutocompleteSelection(items) {
            items.forEach((item, index) => {
                if (index === selectedAutocompleteIndex) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        function closeAutocomplete() {
            const dropdown = document.getElementById('autocompleteDropdown');
            dropdown.classList.remove('active');
            selectedAutocompleteIndex = -1;
        }

        function showError(message) {
            domElements.errorMessage.textContent = message;
            domElements.errorMessage.classList.add('show');
        }

        // Google Maps Integration with async loading support
        function initializeMap() {
            const mapElement = domElements.map;
            if (!mapElement) {
                console.warn('Map element not found');
                return false;
            }
            
            if (!window.google?.maps) {
                console.warn('Google Maps not ready yet');
                return false;
            }
            
            try {
                map = new google.maps.Map(mapElement, {
                    zoom: 11,
                    center: CONFIG.SF_CENTER,
                    mapId: 'da06606e8454cb076fcdd76a', // Map ID for AdvancedMarkerElement support
                    disableDefaultUI: true,
                    zoomControl: true,
                    zoomControlOptions: {
                        position: google.maps.ControlPosition.RIGHT_BOTTOM
                    },
                    gestureHandling: 'cooperative',
                    styles: [
                        {
                            featureType: 'poi',
                            elementType: 'labels',
                            stylers: [{ visibility: 'off' }]
                        }
                    ] // Hide POI labels to reduce clutter
                });
                
                return true;
            } catch (error) {
                console.error('Error initializing Google Maps:', error);
                return false;
            }
        }

        function initializeMapIfNeeded() {
            if (!map && window.googleMapsReady) {
                initializeMap();
            }
        }

        function updateMapZoom(level, coordinates) {
            if (!map || !coordinates) {
                console.warn('Map or coordinates not available for zoom update');
                return;
            }
            
            const zoomConfig = CONFIG.ZOOM_LEVELS[level];
            if (!zoomConfig) {
                console.warn(`Invalid zoom level: ${level}`);
                return;
            }
            
            const config = {
                zoom: zoomConfig.zoom,
                center: level === 1 ? CONFIG.SF_CENTER : coordinates
            };
            
            // Smooth zoom transition
            map.panTo(config.center);
            map.setZoom(config.zoom);
            
            // Add a subtle hint marker at max zoom (level 4) to show general area
            if (level === 4 && !gameState.won && !gameState.lost) {
                addLocationHintMarker(coordinates);
            }
        }

        function addLocationHintMarker(coordinates) {
            if (!map || !window.google?.maps) return;
            
            // Remove any existing hint marker
            if (window.hintMarker) {
                window.hintMarker.setMap(null);
            }
            
            // Add a subtle circle to show the general area
            window.hintMarker = new google.maps.Circle({
                strokeColor: '#3B82F6',
                strokeOpacity: 0.6,
                strokeWeight: 2,
                fillColor: '#3B82F6',
                fillOpacity: 0.15,
                map: map,
                center: coordinates,
                radius: 50 // 50 meter radius hint circle
            });
        }

        function showFinalLocation() {
            if (!map || !gameState.correctCoordinates) {
                console.warn('Cannot show final location: map or coordinates missing');
                return;
            }
            
            // Zoom to exact location
            updateMapZoom(5, gameState.correctCoordinates);
            
            // Add the business marker with animation after a short delay
            setTimeout(() => {
                addBusinessMarker(true);
            }, CONFIG.TIMEOUTS.MARKER_DROP);
        }

        function addBusinessMarker(withAnimation = true) {
            if (!map || !gameState.correctCoordinates || !window.google?.maps) {
                console.warn('Cannot add marker: missing requirements');
                return;
            }
            
            // Remove existing markers
            if (businessMarker) {
                // Check if it's an AdvancedMarkerElement
                if (businessMarker.map) {
                    businessMarker.map = null;
                } else {
                    // Fallback for old Marker
                    businessMarker.setMap(null);
                }
            }
            if (window.hintMarker) {
                window.hintMarker.setMap(null);
                window.hintMarker = null;
            }
            
            // Try to use AdvancedMarkerElement if available (requires Map ID)
            if (google.maps.marker && google.maps.marker.AdvancedMarkerElement) {
                // Create custom pin element
                const pinElement = document.createElement('div');
                pinElement.innerHTML = `
                    <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">
                        <circle cx="16" cy="16" r="12" fill="#EF4444" stroke="white" stroke-width="3"/>
                        <circle cx="16" cy="16" r="6" fill="white"/>
                    </svg>
                `;
                
                // Create the advanced marker
                businessMarker = new google.maps.marker.AdvancedMarkerElement({
                    position: gameState.correctCoordinates,
                    map: map,
                    title: `${currentBusiness.Name}\n${currentBusiness.Address}`,
                    content: pinElement,
                    gmpDraggable: false
                });
                
                // Add animation effect if requested
                if (withAnimation) {
                    pinElement.style.opacity = '0';
                    pinElement.style.transform = 'translateY(-20px)';
                    pinElement.style.transition = 'all 0.5s ease';
                    setTimeout(() => {
                        pinElement.style.opacity = '1';
                        pinElement.style.transform = 'translateY(0)';
                    }, 100);
                }
            } else {
                // Fallback to regular Marker if AdvancedMarkerElement not available
                const pinIcon = {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="16" cy="16" r="12" fill="#EF4444" stroke="white" stroke-width="3"/>
                            <circle cx="16" cy="16" r="6" fill="white"/>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(32, 32),
                    anchor: new google.maps.Point(16, 16)
                };
                
                businessMarker = new google.maps.Marker({
                    position: gameState.correctCoordinates,
                    map: map,
                    title: `${currentBusiness.Name}\n${currentBusiness.Address}`,
                    icon: pinIcon,
                    animation: withAnimation ? google.maps.Animation.DROP : null
                });
            }
            
            // Add info window that opens on click
            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div style="padding: 8px; max-width: 250px;">
                        <h3 style="margin: 0 0 8px 0; color: #1F2937; font-size: 16px;">${currentBusiness.Name}</h3>
                        <p style="margin: 0 0 4px 0; color: #6B7280; font-size: 14px;">üìç ${currentBusiness.Address}</p>
                        <p style="margin: 0 0 4px 0; color: #6B7280; font-size: 14px;">üè∑Ô∏è ${currentBusiness.Category}</p>
                        ${currentBusiness.Signature ? `<p style="margin: 0; color: #059669; font-size: 14px;">‚≠ê ${currentBusiness.Signature}</p>` : ''}
                    </div>
                `
            });
            
            // Add click listener based on marker type
            if (businessMarker.addListener) {
                // Regular Marker
                businessMarker.addListener('click', () => {
                    infoWindow.open(map, businessMarker);
                });
            } else if (businessMarker.element) {
                // AdvancedMarkerElement
                businessMarker.element.addEventListener('click', () => {
                    infoWindow.open(map, businessMarker);
                });
            }
            
            // Auto-open info window after marker drops (for final reveals)
            if (withAnimation) {
                setTimeout(() => {
                    infoWindow.open(map, businessMarker);
                }, CONFIG.TIMEOUTS.INFO_WINDOW);
            }
        }

        function showMap() {
            domElements.mapContainer.style.display = 'block';
            
            // Initialize map if not already done and Google Maps is ready
            if (!map) {
                if (window.googleMapsReady && window.google?.maps) {
                    if (!initializeMap()) {
                        console.error('Failed to initialize map');
                        return;
                    }
                } else {
                    // Wait for Google Maps to load
                    const checkInterval = setInterval(() => {
                        if (window.googleMapsReady && window.google?.maps) {
                            clearInterval(checkInterval);
                            initializeMap();
                        }
                    }, 100);
                    
                    // Timeout after 10 seconds
                    setTimeout(() => {
                        clearInterval(checkInterval);
                        if (!map) {
                            console.error('Google Maps failed to load within timeout');
                        }
                    }, 10000);
                }
            }
        }

        function hideMap() {
            domElements.mapContainer.style.display = 'none';
        }

        // Multiple Choice System with Places API
        async function generateMultipleChoice(businessType, coordinates, radiusMiles) {
            try {
                // Try Places API first
                const placesOptions = await fetchPlacesOptions(businessType, coordinates, radiusMiles);
                
                if (placesOptions.length >= 3) {
                    // Use Places API results
                    const decoys = placesOptions
                        .filter(place => place.name !== currentBusiness.Name)
                        .slice(0, 7); // Take up to 7 decoys
                    
                    const options = [...decoys.map(place => place.name), currentBusiness.Name];
                    return shuffleArray(options);
                } else {
                    // Fallback to curated options if Places API doesn't return enough
                    return generateFallbackOptions();
                }
                
            } catch (error) {
                console.error('Error generating multiple choice:', error);
                // Fallback to curated options
                return generateFallbackOptions();
            }
        }

        async function fetchPlacesOptions(businessType, coordinates, radiusMiles) {
            try {
                // Check cache first
                const cacheKey = `places_${businessType}_${coordinates.lat.toFixed(3)}_${coordinates.lng.toFixed(3)}_${radiusMiles}`;
                const cached = localStorage.getItem(cacheKey);
                const cacheExpiry = localStorage.getItem(`${cacheKey}_expiry`);
                
                // Use cache if it's less than 24 hours old
                if (cached && cacheExpiry && Date.now() < parseInt(cacheExpiry)) {
                    return JSON.parse(cached);
                }
                
                // Use new Places API (New) with Text Search
                const placeType = mapBusinessTypeToPlaceType(businessType);
                console.log(`Business category: "${businessType}" mapped to: "${placeType}"`);
                const searchQuery = `${placeType} near ${coordinates.lat},${coordinates.lng}`;
                console.log(`Places API search query: "${searchQuery}"`);
                
                // Convert miles to meters for radius
                const radiusMeters = Math.min(radiusMiles * 1609.34, 50000); // Max 50km radius
                
                // Note: Places API requires server-side implementation due to CORS restrictions
                // For client-side only implementation, we'll use enhanced curated options
                console.log('Using enhanced curated options for:', placeType, 'near', coordinates);
                
                // Generate location-aware curated options
                const curatedOptions = generateLocationAwareFallback(placeType, coordinates, radiusMiles);
                
                // Cache the curated results
                localStorage.setItem(cacheKey, JSON.stringify(curatedOptions));
                localStorage.setItem(`${cacheKey}_expiry`, (Date.now() + 24 * 60 * 60 * 1000).toString());
                
                return curatedOptions;
                
            } catch (error) {
                console.error('Error fetching Places API data:', error);
                return [];
            }
        }

        function mapBusinessTypeToPlaceType(businessType) {
            if (!businessType) return 'restaurant';
            
            const lowerType = businessType.toLowerCase();
            
            // Smart cuisine detection for restaurants
            // Common cuisine keywords that appear in business categories
            const cuisinePatterns = [
                'chinese', 'italian', 'mexican', 'thai', 'japanese', 'korean', 
                'vietnamese', 'indian', 'french', 'spanish', 'greek', 'mediterranean',
                'american', 'southern', 'bbq', 'barbecue', 'sushi', 'ramen', 'pho',
                'taco', 'burrito', 'pizza', 'pasta', 'dim sum', 'tapas', 'ethiopian',
                'peruvian', 'brazilian', 'argentinian', 'german', 'irish', 'british',
                'middle eastern', 'lebanese', 'turkish', 'moroccan', 'caribbean',
                'cuban', 'salvadoran', 'guatemalan', 'filipino', 'indonesian',
                'malaysian', 'singaporean', 'burmese', 'nepalese', 'afghan',
                'pakistani', 'bangladeshi', 'sri lankan', 'russian', 'polish',
                'hungarian', 'czech', 'scandinavian', 'swedish', 'norwegian'
            ];
            
            // First, check if the category IS a cuisine name directly
            for (const cuisine of cuisinePatterns) {
                if (lowerType === cuisine || lowerType === `${cuisine} food` || lowerType === `${cuisine} cuisine`) {
                    console.log(`Direct cuisine match: "${businessType}" -> "${cuisine} restaurant"`);
                    return `${cuisine} restaurant`;
                }
            }
            
            // Check if it's a restaurant with a specific cuisine
            if (lowerType.includes('restaurant') || lowerType.includes('food') || 
                lowerType.includes('kitchen') || lowerType.includes('bistro') ||
                lowerType.includes('grill') || lowerType.includes('eatery')) {
                
                // Try to find a cuisine modifier
                for (const cuisine of cuisinePatterns) {
                    if (lowerType.includes(cuisine)) {
                        return `${cuisine} restaurant`;
                    }
                }
                
                // No specific cuisine found, return generic restaurant
                return 'restaurant';
            }
            
            // Non-restaurant specific mappings
            const typeMapping = {
                'bakery': 'bakery',
                'coffee': 'coffee shop',
                'bar': 'bar',
                'pub': 'bar',
                'brewery': 'brewery',
                'wine': 'wine bar',
                'cocktail': 'cocktail bar',
                'store': 'store',
                'shop': 'shop',
                'market': 'grocery store',
                'cafe': 'cafe',
                'deli': 'deli',
                'donut': 'donut shop',
                'sandwich': 'sandwich shop',
                'burger': 'burger restaurant',
                'seafood': 'seafood restaurant',
                'steakhouse': 'steakhouse',
                'vegetarian': 'vegetarian restaurant',
                'vegan': 'vegan restaurant',
                'dessert': 'dessert shop',
                'ice cream': 'ice cream shop',
                'juice': 'juice bar',
                'smoothie': 'smoothie shop',
                'tea': 'tea house'
            };
            
            // Try to find a specific match
            for (const [key, value] of Object.entries(typeMapping)) {
                if (lowerType.includes(key)) {
                    return value;
                }
            }
            
            // Final fallback based on common patterns
            if (lowerType.includes('food') || lowerType.includes('eat')) {
                return 'restaurant';
            } else if (lowerType.includes('drink') || lowerType.includes('beverage')) {
                return 'cafe';
            } else if (lowerType.includes('shop') || lowerType.includes('store')) {
                return 'store';
            }
            
            return 'restaurant'; // Most common fallback
        }

        function generateLocationAwareFallback(placeType, coordinates, radiusMiles) {
            // Enhanced location-aware curated options
            const sfBusinesses = {
                bakery: [
                    'Tartine Bakery', 'Arizmendi Bakery', 'Jane the Bakery', 
                    'Craftsman and Wolves', 'B. Patisserie', 'Boudin Bakery',
                    'The Mill', 'Devil\'s Teeth Baking Company', 'Arsicault Bakery'
                ],
                'coffee shop': [
                    'Blue Bottle Coffee', 'Ritual Coffee', 'Sightglass Coffee',
                    'Philz Coffee', 'The Mill', 'Four Barrel Coffee',
                    'Saint Frank Coffee', 'Wrecking Ball Coffee'
                ],
                // Cuisine-specific restaurant fallbacks
                'chinese restaurant': [
                    'Z & Y Bistro', 'House of Nanking', 'R&G Lounge', 'Hunan Home\'s',
                    'Beijing Restaurant', 'Great Eastern', 'Yank Sing', 'Good Luck Dim Sum',
                    'Dragon Well', 'Eric\'s Restaurant', 'San Tung', 'Kingdom of Dumpling'
                ],
                'italian restaurant': [
                    'Tony\'s Pizza Napoletana', 'Cotogna', 'A16', 'Delfina',
                    'Flour + Water', 'Il Pollaio', 'The Italian Homemade Company',
                    'North Beach Restaurant', 'Original Joe\'s', 'Che Fico'
                ],
                'mexican restaurant': [
                    'La Taqueria', 'El Farolito', 'Papalote', 'Nopalito',
                    'Tropisue√±o', 'Gallardo\'s', 'Los Hermanos', 'Taqueria Cancun',
                    'El Castillito', 'La Corneta', 'Pancho Villa', 'Gracias Madre'
                ],
                'japanese restaurant': [
                    'Ju-ni', 'Omakase', 'Wako', 'Ozumo', 'Sanraku',
                    'Katana-Ya', 'Marufuku Ramen', 'Hinodeya', 'Akiko\'s',
                    'Tekka', 'Shizen', 'Okoze Sushi'
                ],
                'thai restaurant': [
                    'Kin Khao', 'Farmhouse Kitchen', 'Marnee Thai', 'Basil Thai',
                    'Osha Thai', 'Lers Ros', 'Derm Restaurant', 'Zen Yai',
                    'Thai Time', 'Chaiya Thai', 'Sweet Basil Thai'
                ],
                // Generic restaurants for when no cuisine is specified
                restaurant: [
                    'Zuni Cafe', 'State Bird Provisions', 'Gary Danko',
                    'House of Prime Rib', 'Swan Oyster Depot', 'Tadich Grill',
                    'The Slanted Door', 'Foreign Cinema', 'Chez Panisse'
                ],
                'donut shop': [
                    'Bob\'s Donuts', 'Johnny Doughnuts', 'Dynamo Donut',
                    'Pepples Donut Farm', 'Stan\'s Donuts', 'Happy Donuts'
                ],
                'mexican restaurant': [
                    'La Taqueria', 'El Farolito', 'Papalote Mexican Grill',
                    'Nopalito', 'Comal', 'Panchita\'s'
                ],
                bar: [
                    'Trick Dog', 'ABV', 'Bourbon & Branch', 'The Alembic',
                    'Local Edition', 'Zeitgeist', 'Tony Nik\'s'
                ],
                cafe: [
                    'Cafe Zoetrope', 'Cafe Trieste', 'Mama\'s on Washington Square',
                    'Peet\'s Coffee', 'Starbucks', 'Cafe Central'
                ]
            };
            
            // Get appropriate category options
            let options = sfBusinesses[placeType];
            
            // If no exact match found, but it's a specific cuisine restaurant
            if (!options && placeType.includes('restaurant')) {
                // Extract the cuisine from the placeType (e.g., "chinese restaurant" -> "chinese")
                const cuisine = placeType.replace(' restaurant', '').trim();
                
                // For cuisines we don't have specific lists for, try to use the most relevant fallback
                // Check if we have any cuisine-specific lists
                const availableCuisines = Object.keys(sfBusinesses).filter(key => key.includes('restaurant') && key !== 'restaurant');
                
                console.log(`No specific fallback for "${placeType}". Available cuisines: ${availableCuisines.join(', ')}`);
                
                // If it's an Asian cuisine, try to use another Asian cuisine as fallback
                const asianCuisines = ['chinese', 'japanese', 'thai', 'vietnamese', 'korean'];
                if (asianCuisines.some(c => cuisine.includes(c))) {
                    // Try to find another Asian cuisine we have
                    for (const asian of ['chinese restaurant', 'japanese restaurant', 'thai restaurant']) {
                        if (sfBusinesses[asian] && asian !== placeType) {
                            console.log(`Using ${asian} as fallback for ${placeType}`);
                            options = sfBusinesses[asian];
                            break;
                        }
                    }
                }
                
                // If it's a Latin cuisine, use another Latin cuisine
                const latinCuisines = ['mexican', 'cuban', 'peruvian', 'salvadoran'];
                if (!options && latinCuisines.some(c => cuisine.includes(c))) {
                    if (sfBusinesses['mexican restaurant']) {
                        console.log(`Using mexican restaurant as fallback for ${placeType}`);
                        options = sfBusinesses['mexican restaurant'];
                    }
                }
                
                // Still no match? Use generic restaurants but log a warning
                if (!options) {
                    console.warn(`WARNING: Using generic restaurants for ${placeType} - this will show wrong cuisine types!`);
                    options = sfBusinesses.restaurant;
                }
            } else if (!options) {
                // Final fallback for non-restaurant categories
                console.log(`No fallback for category "${placeType}", using generic restaurants`);
                options = sfBusinesses.restaurant;
            }
            
            // Don't mix cuisines - if it's a specific cuisine, keep it pure
            // Only add variety for non-cuisine-specific categories
            if (placeType === 'restaurant' || !placeType.includes('restaurant')) {
                // For generic restaurants or non-restaurants, add some variety
                if (placeType !== 'restaurant' && sfBusinesses.restaurant) {
                    options = [...options, ...sfBusinesses.restaurant.slice(0, 2)];
                }
            }
            
            // Simulate distance-based filtering (closer = more specific)
            if (radiusMiles < 1) {
                // Very close - fewer, more specific options
                options = options.slice(0, 6);
            } else if (radiusMiles < 3) {
                // Neighborhood - moderate options
                options = options.slice(0, 8);
            }
            
            // Return as Place-like objects
            return options.map(name => ({
                name: name,
                rating: Math.random() * 2 + 3, // Random rating 3-5
                vicinity: 'San Francisco, CA'
            }));
        }

        function generateFallbackOptions() {
            // Use actual business coordinates if available, otherwise SF center
            const coords = gameState.correctCoordinates || CONFIG.SF_CENTER;
            const mappedType = mapBusinessTypeToPlaceType(currentBusiness.Category);
            
            console.log(`Fallback: Category "${currentBusiness.Category}" mapped to "${mappedType}"`);
            
            return generateLocationAwareFallback(
                mappedType,
                coords,
                10
            ).map(place => place.name);
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function showMultipleChoice(options) {
            const container = domElements.multipleChoiceContainer;
            const grid = domElements.choiceGrid;
            
            // Clear existing options
            grid.innerHTML = '';
            
            // Create choice buttons
            options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'choice-button';
                button.textContent = option;
                button.onclick = () => handleMultipleChoiceGuess(option, button);
                grid.appendChild(button);
            });
            
            container.style.display = 'block';
        }

        function hideMultipleChoice() {
            domElements.multipleChoiceContainer.style.display = 'none';
        }

        /**
         * Provide visual feedback for multiple choice guess
         */
        function applyGuessVisualFeedback(buttonElement, isCorrect) {
            buttonElement.classList.add(isCorrect ? 'correct' : 'wrong');
            
            // Disable all buttons
            const allButtons = document.querySelectorAll('.choice-button');
            allButtons.forEach(btn => btn.style.pointerEvents = 'none');
        }
        
        /**
         * Handle correct guess in multiple choice mode
         */
        function handleCorrectMultipleChoice() {
            gameState.won = true;
            gameState.pointsEarned = calculatePoints(gameState.guesses.length);
            karlCelebrate(); // Karl celebrates the win!
            
            // Immediately add marker when they get it right
            addBusinessMarker(true);
            
            // Zoom to exact location if not already there
            if (gameState.round < 4) {
                updateMapZoom(5, gameState.correctCoordinates);
            }
            
            // Show winning message after celebration
            setTimeout(() => {
                endGame(true);
            }, CONFIG.TIMEOUTS.WIN_CELEBRATION);
        }
        
        /**
         * Handle wrong guess in multiple choice mode
         */
        function handleWrongMultipleChoice() {
            if (gameState.round >= 4) {
                // Out of rounds - show final location
                gameState.lost = true;
                showFinalLocation();
                setTimeout(() => {
                    endGame(false);
                }, CONFIG.TIMEOUTS.LOSE_REVEAL);
            } else {
                // Progress to next round
                gameState.round++;
                progressToNextRound();
            }
        }
        
        function handleMultipleChoiceGuess(guess, buttonElement) {
            const isCorrect = guess === currentBusiness.Name;
            
            // Apply visual feedback
            applyGuessVisualFeedback(buttonElement, isCorrect);
            
            // Add to game state
            gameState.guesses.push({
                text: guess,
                correct: isCorrect
            });
            
            // Handle outcome after visual feedback delay
            setTimeout(() => {
                if (isCorrect) {
                    handleCorrectMultipleChoice();
                } else {
                    handleWrongMultipleChoice();
                }
                saveGameState();
            }, CONFIG.TIMEOUTS.CHOICE_FEEDBACK);
        }

        async function init() {
            try {
                // Initialize DOM element cache first
                initializeDOMCache();
                
                allBusinesses = await fetchBusinessData();
                
                if (allBusinesses.length === 0) {
                    throw new Error('No businesses available');
                }
                
                currentBusiness = getTodaysBusiness(allBusinesses);
                
                if (!currentBusiness) {
                    throw new Error('Could not load today\'s business');
                }
                
                domElements.businessPhoto.src = currentBusiness.PhotoURL;
                domElements.funFact.textContent = currentBusiness.FunFact;
                // Note: hint content is now populated dynamically via revealHint() function
                
                // Pre-load coordinates for better performance
                if (currentBusiness.Address) {
                    geocodeAddress(currentBusiness.Address).then(coords => {
                        gameState.correctCoordinates = coords;
                    }).catch(error => {
                        console.warn('Failed to pre-load coordinates:', error);
                    });
                }
                
                domElements.loading.style.display = 'none';
                domElements.gameContent.style.display = 'block';
                
                // Ensure header is visible for fresh games
                const header = document.querySelector('header');
                if (header && (!gameState.hintsRevealed || gameState.hintsRevealed === 0)) {
                    header.classList.remove('hidden');
                }
                
                // Ensure hints section is visible for active games (but not completed games)
                if (domElements.newHints && !gameState.won && !gameState.lost) {
                    domElements.newHints.style.display = 'block';
                }
                
                initializeGame();

                // Show tutorial for first-time users
                const tutorialSeen = localStorage.getItem('tutorialSeen');
                if (!tutorialSeen) {
                    // Delay slightly to ensure DOM is fully rendered
                    setTimeout(() => {
                        showTutorial();
                    }, 500);
                }

                // Initialize Karl the Fog
                initializeKarl();
                setupAutocomplete();
                
                // Restore UI state after business is loaded
                if (gameState.hintsRevealed > 0 || gameState.won || gameState.lost) {
                    restoreGameUI();
                }
                
                domElements.guessInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && selectedAutocompleteIndex === -1) {
                        e.preventDefault();
                        submitGuess();
                    }
                });
                
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        if (domElements.tutorialModal.classList.contains('show')) {
                            closeTutorial();
                        } else if (domElements.whyBizzleModal.classList.contains('show')) {
                            closeWhyBizzle();
                        } else if (domElements.statsModal.classList.contains('show')) {
                            closeStats();
                        } else if (domElements.debugModal.classList.contains('show')) {
                            closeDebug();
                        }
                    }
                });
                
            } catch (error) {
                console.error('Initialization error:', error);
                domElements.loading.style.display = 'none';
                showError('Failed to initialize game. Please refresh the page.');
            }
        }

        init();
    </script>
</body>
</html>