<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bizzle - Daily SF Business Guessing Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #FAFAFA;
            color: #1A1A1A;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            font-size: 16px;
        }

        .container {
            max-width: 520px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
        }

        header {
            text-align: center;
            padding: 24px 0;
            background: linear-gradient(135deg, #F8FAFC 0%, #E2E8F0 100%);
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid #E2E8F0;
        }

        h1 {
            font-size: 36px;
            font-weight: 800;
            background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 4px;
        }

        .tagline {
            font-size: 16px;
            color: #64748B;
            font-weight: 500;
            margin-top: 8px;
        }

        .stats-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
        }

        .debug-button {
            position: absolute;
            top: 20px;
            right: 70px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            opacity: 0.6;
        }

        .debug-button:hover {
            opacity: 1;
        }

        .game-number {
            font-size: 14px;
            color: #64748B;
            margin-top: 12px;
            font-weight: 600;
            background: rgba(59, 130, 246, 0.1);
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
        }

        .photo-container {
            width: 100%;
            max-height: 300px;
            overflow: hidden;
            border-radius: 16px;
            margin-bottom: 24px;
            background: #E5E5E5;
            position: relative;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            border: 3px solid white;
        }

        .photo-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #666;
        }

        .fun-fact {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            border: 1px solid #F59E0B;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            font-size: 15px;
            line-height: 1.6;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.1);
        }

        .clue-label {
            font-weight: 700;
            color: #92400E;
            margin-bottom: 8px;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .new-hints {
            margin-bottom: 24px;
        }

        .new-hints .hint {
            margin-bottom: 16px;
        }

        .new-hints .hint:first-child {
            border: 3px solid #3B82F6;
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.25);
            transform: scale(1.02);
        }

        .hint {
            background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%);
            border: 2px solid #3B82F6;
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: block;
            animation: slideInFromTop 0.5s ease-out;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
            font-size: 16px;
            font-weight: 500;
            opacity: 0;
            transform: translateY(-20px);
        }

        .hint.revealed {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.5s ease-out;
        }

        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hint.revealed {
            display: block;
        }

        .hint-label {
            font-weight: 700;
            color: #1E40AF;
            font-size: 14px;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.75px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .guess-section {
            margin-bottom: 24px;
            position: relative;
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 2px solid #E5E7EB;
        }

        .guess-counter {
            text-align: center;
            margin-bottom: 16px;
            font-weight: 600;
            font-size: 14px;
            color: #64748B;
            background: #F1F5F9;
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            width: 100%;
            box-sizing: border-box;
        }

        .guess-counter.warning {
            color: #D97706;
            background: #FEF3C7;
        }

        .guess-counter.danger {
            color: #DC2626;
            background: #FEE2E2;
        }

        .give-up-container {
            text-align: center;
            margin-top: 16px;
        }

        .give-up-button {
            background: #6B7280;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.7;
        }

        .give-up-button:hover:not(:disabled) {
            background: #4B5563;
            opacity: 1;
            transform: translateY(-1px);
        }

        .give-up-button:disabled {
            background: #9CA3AF;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .guess-input-container {
            position: relative;
        }

        .guess-input {
            width: 100%;
            height: 56px;
            padding: 0 60px 0 20px;
            font-size: 18px;
            font-weight: 500;
            border: 3px solid #E5E7EB;
            border-radius: 12px;
            transition: all 0.3s ease;
            background: #FAFBFC;
        }

        .guess-input:focus {
            outline: none;
            border-color: #3B82F6;
            background: white;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        .guess-input:disabled {
            background: #F3F4F6;
            cursor: not-allowed;
        }

        .submit-button {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
            color: white;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .submit-button:hover:not(:disabled) {
            background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .submit-button:disabled {
            background: #9CA3AF;
            cursor: not-allowed;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #E5E5E5;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            margin-top: 4px;
            display: none;
        }

        .autocomplete-dropdown.active {
            display: block;
        }

        .autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #F3F4F6;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: #F3F4F6;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .guesses-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 24px;
            padding: 16px;
            background: #F8FAFC;
            border-radius: 12px;
            border: 1px solid #E2E8F0;
            position: relative;
        }

        .guesses-grid::before {
            content: "Your Guesses";
            position: absolute;
            top: -12px;
            left: 16px;
            background: #F8FAFC;
            padding: 0 8px;
            font-size: 12px;
            font-weight: 600;
            color: #64748B;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .guess-slot {
            height: 52px;
            background: white;
            border: 2px dashed #CBD5E1;
            border-radius: 10px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            color: #64748B;
        }

        .guess-slot.correct {
            background: linear-gradient(135deg, #22C55E 0%, #16A34A 100%);
            color: white;
            border: 2px solid #16A34A;
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
            transform: scale(1.02);
        }

        .guess-slot.wrong {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            color: white;
            border: 2px solid #DC2626;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        .game-end {
            display: none;
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            position: relative;
            z-index: 1000;
            border: 3px solid #22C55E;
        }

        .game-end.show {
            display: block !important;
            animation: slideIn 0.5s ease-out;
        }

        .result-message {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .result-message.win {
            color: #22C55E;
        }

        .result-message.lose {
            color: #EF4444;
        }

        .business-name-reveal {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .business-details {
            text-align: left;
            background: #F3F4F6;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
        }

        .business-details p {
            margin-bottom: 8px;
            font-size: 14px;
        }

        .business-details strong {
            color: #3B82F6;
        }

        .share-button {
            background: #3B82F6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 16px;
        }

        .share-button:hover {
            background: #2563EB;
        }

        .share-button.copied {
            background: #22C55E;
        }

        .countdown {
            margin-top: 20px;
            padding: 16px;
            background: #F3F4F6;
            border-radius: 8px;
            text-align: center;
        }

        .countdown-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .countdown-time {
            font-size: 24px;
            font-weight: 700;
            color: #3B82F6;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            padding: 20px;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .stats-grid .stat-item:nth-child(n+4) {
            grid-column: span 2;
            max-width: 200px;
            margin: 0 auto;
        }

        .stat-item {
            text-align: center;
            padding: 16px;
            background: #F3F4F6;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #3B82F6;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .debug-options {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .debug-section {
            border-bottom: 1px solid #E5E7EB;
            padding-bottom: 16px;
        }

        .debug-section:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .debug-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #374151;
        }

        .debug-section p {
            font-size: 14px;
            margin-bottom: 8px;
            color: #6B7280;
        }

        .debug-btn {
            background: #6B7280;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            margin: 4px 8px 4px 0;
            transition: background 0.2s;
        }

        .debug-btn:hover {
            background: #4B5563;
        }

        .debug-btn.danger {
            background: #DC2626;
        }

        .debug-btn.danger:hover {
            background: #B91C1C;
        }

        /* Map Styles */
        .map-container {
            margin-bottom: 24px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 2px solid #E5E7EB;
        }

        .map {
            width: 100%;
            height: 300px;
        }

        .map-label {
            background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%);
            padding: 12px 16px;
            text-align: center;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        /* Multiple Choice Styles */
        .multiple-choice-container {
            margin-bottom: 24px;
        }

        .choice-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
            text-align: center;
            font-size: 16px;
        }

        .choice-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }

        .choice-button {
            background: white;
            border: 2px solid #E5E7EB;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-weight: 500;
        }

        .choice-button:hover {
            border-color: #3B82F6;
            background: #F8FAFC;
            transform: translateY(-1px);
        }

        .choice-button.correct {
            background: linear-gradient(135deg, #22C55E 0%, #16A34A 100%);
            border-color: #16A34A;
            color: white;
        }

        .choice-button.wrong {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            border-color: #DC2626;
            color: white;
        }

        .error-message {
            background: #FEE2E2;
            color: #991B1B;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        @media (max-width: 480px) {
            .container {
                padding: 16px;
            }

            h1 {
                font-size: 32px;
            }

            .stats-button {
                top: 20px;
                right: 20px;
            }

            .debug-button {
                top: 20px;
                right: 70px;
            }

            .guess-section {
                padding: 16px;
                margin-bottom: 20px;
            }

            .guess-input {
                height: 52px;
                font-size: 16px;
                padding: 0 56px 0 16px;
            }

            .submit-button {
                width: 40px;
                height: 40px;
            }

            .photo-container {
                max-height: 250px;
                margin-bottom: 20px;
            }

            .guesses-grid {
                padding: 12px;
            }

            .guess-slot {
                height: 48px;
                font-size: 15px;
            }

            .give-up-button {
                font-size: 12px;
                padding: 6px 14px;
            }

            .map {
                height: 250px;
            }

            .choice-grid {
                gap: 6px;
            }

            .choice-button {
                padding: 10px 12px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button class="stats-button" onclick="showStats()" aria-label="View Statistics">📊</button>
            <button class="debug-button" onclick="showDebug()" aria-label="Debug Menu">🔧</button>
            <h1>🏪 Bizzle</h1>
            <p class="tagline">Guess the SF small business!</p>
            <p class="game-number" id="gameNumber"></p>
        </header>

        <div class="error-message" id="errorMessage"></div>

        <div class="loading" id="loading">
            <span>Loading today's business...</span>
        </div>

        <div id="gameContent" style="display: none;">
            <!-- Guess Section at Top -->
            <div id="guessSection" class="guess-section">
                <div class="guess-counter">
                    <span id="guessCounter">5 guesses remaining</span>
                </div>
                <div class="guess-input-container">
                    <input type="text" 
                           id="guessInput" 
                           class="guess-input" 
                           placeholder="What business is this?"
                           autocomplete="off">
                    <button id="submitButton" class="submit-button" onclick="submitGuess()" title="Submit guess">→</button>
                    <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
                </div>
                <div class="give-up-container">
                    <button id="giveUpButton" class="give-up-button" onclick="giveUp()" title="Reveal the answer">🏳️ I give up</button>
                </div>
            </div>

            <!-- Game End Section (NEW CONTENT AT TOP) -->
            <div class="game-end" id="gameEnd">
                <div class="result-message" id="resultMessage"></div>
                <div class="business-name-reveal" id="businessNameReveal"></div>
                <div class="business-details" id="businessDetails"></div>
                <button class="share-button" id="shareButton" onclick="shareResult()">Share Result</button>
                <div class="countdown">
                    <div class="countdown-label">Next Bizzle in</div>
                    <div class="countdown-time" id="countdownTime"></div>
                </div>
            </div>

            <!-- Dynamic Hints Section (newest hints at top) -->
            <div class="new-hints" id="newHints">
                <!-- Hints will be dynamically prepended here, newest first -->
            </div>

            <!-- Map Section (shown during multiple choice phase) -->
            <div class="map-container" id="mapContainer" style="display: none;">
                <div id="map" class="map"></div>
                <div class="map-label">🗺️ Find the business on the map</div>
            </div>

            <!-- Multiple Choice Section -->
            <div class="multiple-choice-container" id="multipleChoiceContainer" style="display: none;">
                <div class="choice-label">Choose the correct business:</div>
                <div class="choice-grid" id="choiceGrid">
                    <!-- Multiple choice buttons will be added dynamically -->
                </div>
            </div>

            <!-- Photo Section (always visible baseline) -->
            <div class="photo-container">
                <img id="businessPhoto" alt="Business interior photo">
            </div>

            <!-- Fun Fact Section (always visible baseline) -->
            <div class="fun-fact">
                <div class="clue-label">💡 Fun Fact</div>
                <div id="funFact"></div>
            </div>

            <!-- Previous Guesses Display (shown at bottom after game ends) -->
            <div class="guesses-grid" id="guessesGrid" style="display: none;">
                <!-- Guess slots will be added dynamically -->
            </div>
        </div>
    </div>

    <div class="modal" id="statsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Statistics</h2>
                <button class="close-button" onclick="closeStats()">×</button>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="gamesPlayed">0</div>
                    <div class="stat-label">Games Played</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="winPercentage">0%</div>
                    <div class="stat-label">Win Rate</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="currentStreak">0</div>
                    <div class="stat-label">Current Streak</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="maxStreak">0</div>
                    <div class="stat-label">Max Streak</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalPoints">0</div>
                    <div class="stat-label">Total Points</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="debugModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">🔧 Debug Menu</h2>
                <button class="close-button" onclick="closeDebug()">×</button>
            </div>
            <div class="debug-options">
                <div class="debug-section">
                    <h3>Clear Data</h3>
                    <button class="debug-btn" onclick="clearTodaysGame()">Reset Today's Game</button>
                    <button class="debug-btn" onclick="clearAllStats()">Clear All Statistics</button>
                    <button class="debug-btn" onclick="clearBusinessCache()">Clear Business Cache</button>
                    <button class="debug-btn danger" onclick="clearAllData()">Clear Everything</button>
                </div>
                <div class="debug-section">
                    <h3>API Testing</h3>
                    <button class="debug-btn" onclick="testPlacesAPI()">Test Places API</button>
                </div>
                <div class="debug-section">
                    <h3>Game Info</h3>
                    <p><strong>Day:</strong> <span id="debugDay"></span></p>
                    <p><strong>Guesses:</strong> <span id="debugGuesses"></span></p>
                    <p><strong>Game State:</strong> <span id="debugState"></span></p>
                    <p><strong>Business:</strong> <span id="debugBusiness"></span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Maps JavaScript API with proper async loading -->
    <script>
        // Modern async Google Maps loading
        function initGoogleMaps() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyAkcxjO6ptmguM6UnYEu2CkdI2cIcsr5Ww&libraries=places&callback=onGoogleMapsReady&loading=async`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }
        
        // Callback when Google Maps is ready
        function onGoogleMapsReady() {
            console.log('Google Maps API loaded successfully');
            window.googleMapsReady = true;
            // Initialize map if game content is already visible
            if (document.getElementById('gameContent').style.display !== 'none') {
                initializeMapIfNeeded();
            }
        }
        
        // Load Google Maps when page is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initGoogleMaps);
        } else {
            initGoogleMaps();
        }
    </script>
    
    <script>
        const SHEET_ID = '1aCuaC2pMPs7cnaBc9-reGxq8SKJIpIaCRd6rhUtTJgg';
        const API_KEY = 'AIzaSyAkcxjO6ptmguM6UnYEu2CkdI2cIcsr5Ww';
        const RANGE = 'Sheet1!A:J';
        
        // San Francisco center coordinates
        const SF_CENTER = { lat: 37.7749, lng: -122.4194 };

        let currentBusiness = null;
        let allBusinesses = [];
        let gameState = {
            date: null,
            guesses: [],
            hintsRevealed: 0,
            won: false,
            lost: false,
            statsUpdated: false, // Track if stats were already updated for this game
            phase: 'freeform', // 'freeform' | 'multiple-choice'
            round: 1, // 1-5
            mapZoomLevel: 0,
            multipleChoiceOptions: [],
            correctCoordinates: null,
            pointsEarned: 0 // Points earned this game
        };
        let selectedAutocompleteIndex = -1;
        let map = null;
        let businessMarker = null;

        async function fetchBusinessData() {
            try {
                const cacheKey = 'businessCache';
                const cacheDate = 'businessCacheDate';
                const today = new Date().toDateString();
                
                const cachedDate = localStorage.getItem(cacheDate);
                const cachedData = localStorage.getItem(cacheKey);
                
                if (cachedDate === today && cachedData) {
                    return JSON.parse(cachedData);
                }
                
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch data from Google Sheets');
                }
                
                const data = await response.json();
                const rows = data.values;
                
                if (!rows || rows.length < 2) {
                    throw new Error('No data found in spreadsheet');
                }
                
                const headers = rows[0];
                const businesses = rows.slice(1).map(row => {
                    const business = {};
                    headers.forEach((header, index) => {
                        business[header] = row[index] || '';
                    });
                    return business;
                });
                
                localStorage.setItem(cacheKey, JSON.stringify(businesses));
                localStorage.setItem(cacheDate, today);
                
                return businesses;
            } catch (error) {
                console.error('Error fetching business data:', error);
                showError('Failed to load today\'s business. Please try refreshing the page.');
                return [];
            }
        }

        function getTodaysBusiness(businesses) {
            const today = new Date().toISOString().split('T')[0];
            
            const scheduledBusiness = businesses.find(b => b.DateToFeature === today);
            if (scheduledBusiness) {
                return scheduledBusiness;
            }
            
            const daysSinceEpoch = Math.floor((new Date() - new Date('2025-08-10')) / (1000 * 60 * 60 * 24));
            const index = daysSinceEpoch % businesses.length;
            return businesses[index];
        }

        function getDayNumber() {
            const startDate = new Date('2025-08-10'); // Game launch date
            const today = new Date();
            const daysDiff = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
            return Math.max(1, daysDiff + 1); // Ensure it's at least 1
        }

        // Geocoding system with localStorage caching
        async function geocodeAddress(address) {
            try {
                // Check cache first
                const cacheKey = `coords_${address}`;
                const cached = localStorage.getItem(cacheKey);
                if (cached) {
                    return JSON.parse(cached);
                }
                
                // Geocode via API if not cached
                const encodedAddress = encodeURIComponent(address);
                const response = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodedAddress}&key=${API_KEY}`);
                const data = await response.json();
                
                if (data.status === 'OK' && data.results.length > 0) {
                    const coords = {
                        lat: data.results[0].geometry.location.lat,
                        lng: data.results[0].geometry.location.lng
                    };
                    
                    // Cache for future use
                    localStorage.setItem(cacheKey, JSON.stringify(coords));
                    return coords;
                } else {
                    console.warn('Geocoding failed for address:', address, 'Status:', data.status);
                    // Return SF center as fallback
                    return SF_CENTER;
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                // Return SF center as fallback
                return SF_CENTER;
            }
        }

        function calculatePoints(guessNumber) {
            // Points: 5 for first guess, 4 for second, 3 for third, 2 for fourth, 1 for fifth
            return Math.max(1, 6 - guessNumber);
        }

        function fuzzyMatch(guess, answer) {
            const cleanString = (str) => {
                return str.toLowerCase()
                    .replace(/^(the|a|an)\s+/i, '')
                    .replace(/\s*(san francisco|sf)\s*/gi, '')
                    .replace(/[^a-z0-9]/g, '');
            };
            
            const cleanGuess = cleanString(guess);
            const cleanAnswer = cleanString(answer);
            
            if (cleanGuess === cleanAnswer) return true;
            
            const longer = cleanGuess.length > cleanAnswer.length ? cleanGuess : cleanAnswer;
            const shorter = cleanGuess.length > cleanAnswer.length ? cleanAnswer : cleanGuess;
            
            let matches = 0;
            for (let i = 0; i < shorter.length; i++) {
                if (shorter[i] === longer[i]) matches++;
            }
            
            return matches / longer.length >= 0.8;
        }

        function initializeGame() {
            const today = new Date().toDateString();
            const savedState = localStorage.getItem('gameState');
            const lastPlayed = localStorage.getItem('lastPlayed');
            
            if (savedState && lastPlayed === today) {
                gameState = JSON.parse(savedState);
                // Don't restore UI here - wait until business is loaded
            } else {
                gameState = {
                    date: today,
                    guesses: [],
                    hintsRevealed: 0,
                    won: false,
                    lost: false,
                    statsUpdated: false,
                    phase: 'freeform',
                    round: 1,
                    mapZoomLevel: 0,
                    multipleChoiceOptions: [],
                    correctCoordinates: null,
                    pointsEarned: 0
                };
                saveGameState();
            }
            
            document.getElementById('gameNumber').textContent = `Bizzle #${getDayNumber()}`;
            updateGuessCounter();
        }

        function saveGameState() {
            localStorage.setItem('gameState', JSON.stringify(gameState));
            localStorage.setItem('lastPlayed', new Date().toDateString());
        }

        function restoreGameUI() {
            // Safety checks for required elements
            const guessSection = document.getElementById('guessSection');
            const guessesGrid = document.getElementById('guessesGrid');
            const hintsContainer = document.getElementById('newHints');
            
            if (!guessSection || !guessesGrid || !hintsContainer) {
                console.error('Required elements not found during UI restore');
                return;
            }
            
            // Handle different game phases
            if (gameState.won || gameState.lost) {
                // Game complete
                guessSection.style.display = 'none';
                hideMultipleChoice();
                if (gameState.correctCoordinates) {
                    showMap();
                    showFinalLocation(); // Show exact location with marker
                }
                guessesGrid.style.display = 'block';
                endGame(gameState.won);
            } else if (gameState.phase === 'multiple-choice') {
                // In multiple choice phase
                guessSection.style.display = 'none';
                showMap();
                if (gameState.correctCoordinates) {
                    // Use current round for zoom level (progressive zooming)
                    const currentZoomLevel = gameState.round;
                    console.log(`Restoring map zoom to level ${currentZoomLevel} for round ${gameState.round}`);
                    updateMapZoom(currentZoomLevel, gameState.correctCoordinates);
                }
                if (gameState.multipleChoiceOptions.length > 0) {
                    showMultipleChoice(gameState.multipleChoiceOptions);
                }
            } else {
                // Free-form phase
                updateGuessCounter();
                hideMap();
                hideMultipleChoice();
            }
            
            // Recreate guess slots for existing guesses
            gameState.guesses.forEach((guess, index) => {
                addGuessSlot(guess.text, guess.correct);
            });
            
            // Clear any existing hints and recreate them in reverse order (newest first)
            hintsContainer.innerHTML = '';
            
            // Reveal hints in reverse order so newest appears at top
            for (let i = gameState.hintsRevealed; i >= 1; i--) {
                revealHint(i);
            }
        }

        function revealHint(hintNumber) {
            const hintsContainer = document.getElementById('newHints');
            
            // Don't try to reveal hints if business isn't loaded yet
            if (!currentBusiness) {
                console.warn('Cannot reveal hint: business not loaded yet');
                return;
            }
            
            // Define hint data
            const hintData = {
                1: { label: '📍 Neighborhood', content: currentBusiness.Neighborhood },
                2: { label: '⭐ Signature Item', content: currentBusiness.Signature },
                3: { label: '🏷️ Category', content: currentBusiness.Category },
                4: { label: '🛣️ Street', content: currentBusiness.Street }
            };
            
            const hint = hintData[hintNumber];
            if (!hint) return;
            
            // Check if hint already exists to avoid duplicates
            if (document.getElementById(`hint${hintNumber}`)) {
                return;
            }
            
            // Create new hint element
            const hintElement = document.createElement('div');
            hintElement.className = 'hint';
            hintElement.id = `hint${hintNumber}`;
            hintElement.innerHTML = `
                <div class="hint-label">${hint.label}</div>
                <div>${hint.content}</div>
            `;
            
            // Add it to the TOP of the hints container (prepend)
            hintsContainer.prepend(hintElement);
            
            // Trigger animation after DOM insertion
            requestAnimationFrame(() => {
                hintElement.classList.add('revealed');
            });
        }

        function addGuessSlot(guessText, isCorrect) {
            const guessesGrid = document.getElementById('guessesGrid');
            const guessSlot = document.createElement('div');
            guessSlot.className = 'guess-slot';
            guessSlot.textContent = guessText;
            
            if (isCorrect) {
                guessSlot.classList.add('correct');
            } else {
                guessSlot.classList.add('wrong');
            }
            
            guessesGrid.appendChild(guessSlot);
            // Don't show during gameplay - only at the end
        }

        function updateGuessCounter() {
            const counter = document.getElementById('guessCounter');
            
            // Safety check - if counter doesn't exist (game might be complete), skip update
            if (!counter) {
                return;
            }
            
            const remaining = 5 - gameState.guesses.length;
            
            if (gameState.won) {
                counter.textContent = `Solved in ${gameState.guesses.length} guess${gameState.guesses.length === 1 ? '' : 'es'}!`;
                counter.className = 'guess-counter';
            } else if (gameState.lost) {
                counter.textContent = 'No guesses remaining';
                counter.className = 'guess-counter danger';
            } else {
                counter.textContent = `${remaining} guess${remaining === 1 ? '' : 'es'} remaining`;
                
                if (remaining <= 1) {
                    counter.className = 'guess-counter danger';
                } else if (remaining <= 2) {
                    counter.className = 'guess-counter warning';
                } else {
                    counter.className = 'guess-counter';
                }
            }
        }

        function giveUp() {
            if (gameState.won || gameState.lost) return;
            
            if (confirm('Are you sure you want to give up and see the answer?')) {
                gameState.lost = true;
                gameState.gaveUp = true; // Track that they gave up vs ran out of guesses
                
                // Reveal all remaining hints in reverse order (newest first)
                for (let i = 4; i >= 1; i--) {
                    if (i > gameState.hintsRevealed) {
                        revealHint(i);
                    }
                }
                gameState.hintsRevealed = 4;
                
                // Show final map state with marker
                if (gameState.correctCoordinates) {
                    showMap();
                    updateMapZoom(4, gameState.correctCoordinates);
                }
                
                updateGuessCounter();
                endGame(false);
                saveGameState();
            }
        }

        function submitGuess() {
            const input = document.getElementById('guessInput');
            const guess = input.value.trim();
            
            if (!guess || gameState.won || gameState.lost) return;
            
            const isCorrect = fuzzyMatch(guess, currentBusiness.Name);
            
            gameState.guesses.push({
                text: guess,
                correct: isCorrect
            });
            
            addGuessSlot(guess, isCorrect);
            updateGuessCounter();
            
            if (isCorrect) {
                gameState.won = true;
                gameState.pointsEarned = calculatePoints(gameState.guesses.length);
                endGame(true);
            } else {
                // Transition to multiple choice mode after first wrong guess
                gameState.phase = 'multiple-choice';
                gameState.round = 2;
                transitionToMultipleChoice();
            }
            
            saveGameState();
            input.value = '';
            closeAutocomplete();
        }

        async function transitionToMultipleChoice() {
            console.log('Transitioning to multiple choice mode');
            
            // Hide the free-form guess section
            const guessSection = document.getElementById('guessSection');
            guessSection.style.display = 'none';
            
            // Show the map with initial SF-wide view
            showMap();
            
            // Wait for coordinates if not already available
            if (!gameState.correctCoordinates) {
                console.log('Geocoding business address...');
                gameState.correctCoordinates = await geocodeAddress(currentBusiness.Address);
                console.log('Coordinates obtained:', gameState.correctCoordinates);
            }
            
            // Start with SF-wide view (zoom level 1) before first multiple choice round
            updateMapZoom(1, gameState.correctCoordinates);
            
            // Wait a moment for map to settle, then start first multiple choice round
            setTimeout(() => {
                progressToNextRound();
            }, 1000);
        }

        async function progressToNextRound() {
            console.log(`Starting round ${gameState.round}`);
            
            // Update map zoom based on current round (progressive zoom)
            const zoomLevel = gameState.round; // Round 2=zoom level 2, Round 3=zoom level 3, etc.
            updateMapZoom(zoomLevel, gameState.correctCoordinates);
            
            // Progressive radius and option count based on round
            const roundConfig = {
                2: { radius: 8, maxOptions: 8, label: 'SF-wide' },  // City-wide
                3: { radius: 2, maxOptions: 6, label: 'Neighborhood' }, // Neighborhood
                4: { radius: 0.5, maxOptions: 4, label: 'Nearby' }  // Street-level
            };
            
            const config = roundConfig[gameState.round] || roundConfig[2];
            
            // Update map label with loading state
            const mapLabel = document.querySelector('.map-label');
            if (mapLabel) {
                mapLabel.textContent = `🗺️ Loading ${config.label.toLowerCase()} options...`;
            }
            
            try {
                // Generate multiple choice options
                let options = await generateMultipleChoice(
                    currentBusiness.Category, 
                    gameState.correctCoordinates, 
                    config.radius
                );
                
                // Limit options based on round (more specific = fewer options)
                if (options.length > config.maxOptions) {
                    const correctAnswer = currentBusiness.Name;
                    const otherOptions = options.filter(opt => opt !== correctAnswer);
                    const limitedOthers = shuffleArray(otherOptions).slice(0, config.maxOptions - 1);
                    options = shuffleArray([...limitedOthers, correctAnswer]);
                }
                
                gameState.multipleChoiceOptions = options;
                
                // Update map label
                if (mapLabel) {
                    mapLabel.textContent = `🗺️ ${config.label} - Round ${gameState.round}`;
                }
                
                // Show multiple choice UI
                showMultipleChoice(options);
                
            } catch (error) {
                console.error('Error in progressToNextRound:', error);
                
                // Fallback to basic options
                const fallbackOptions = generateFallbackOptions();
                gameState.multipleChoiceOptions = fallbackOptions;
                
                if (mapLabel) {
                    mapLabel.textContent = `🗺️ ${config.label} - Find the business`;
                }
                
                showMultipleChoice(fallbackOptions);
            }
            
            // Reveal a hint based on the round
            const hintMap = {
                2: 1, // Neighborhood
                3: 2, // Signature Item
                4: 3  // Category
            };
            
            const hintNumber = hintMap[gameState.round];
            if (hintNumber && hintNumber <= 4) {
                revealHint(hintNumber);
                gameState.hintsRevealed = Math.max(gameState.hintsRevealed, hintNumber);
            }
        }

        function endGame(won) {
            console.log('🎉 ENDING GAME - Won:', won);
            
            // Hide the multiple choice interface
            hideMultipleChoice();
            
            // Show the guess history now that game is over
            const guessesGrid = document.getElementById('guessesGrid');
            if (gameState.guesses.length > 0) {
                guessesGrid.style.display = 'block';
            }
            
            const gameEnd = document.getElementById('gameEnd');
            const resultMessage = document.getElementById('resultMessage');
            const businessNameReveal = document.getElementById('businessNameReveal');
            const businessDetails = document.getElementById('businessDetails');
            
            console.log('🎯 Game end element found:', !!gameEnd);
            console.log('📍 Current gameEnd display style:', gameEnd?.style.display);
            console.log('📍 Current gameEnd classes:', gameEnd?.className);
            
            // Make sure game end section is visible with multiple approaches
            if (gameEnd) {
                gameEnd.style.display = 'block';
                gameEnd.style.visibility = 'visible';
                gameEnd.style.opacity = '1';
                gameEnd.classList.add('show');
                
                // Scroll to game end section
                setTimeout(() => {
                    gameEnd.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
                
                console.log('✅ Game end section made visible');
            } else {
                console.error('❌ Game end element not found!');
            }
            
            if (won) {
                resultMessage.textContent = `🎉 Amazing! Got it in ${gameState.guesses.length} ${gameState.guesses.length === 1 ? 'guess' : 'guesses'}! (+${gameState.pointsEarned} points)`;
                resultMessage.className = 'result-message win';
            } else {
                if (gameState.gaveUp) {
                    resultMessage.textContent = 'No worries! Now you know for next time!';
                } else {
                    resultMessage.textContent = 'Better luck tomorrow!';
                }
                resultMessage.className = 'result-message lose';
            }
            
            businessNameReveal.textContent = currentBusiness.Name;
            
            businessDetails.innerHTML = `
                <p><strong>Address:</strong> ${currentBusiness.Address}</p>
                <p><strong>Neighborhood:</strong> ${currentBusiness.Neighborhood}</p>
                <p><strong>Category:</strong> ${currentBusiness.Category}</p>
                <p><strong>Signature:</strong> ${currentBusiness.Signature}</p>
                ${currentBusiness.Website ? `<p><strong>Website:</strong> <a href="${currentBusiness.Website}" target="_blank">${currentBusiness.Website}</a></p>` : ''}
            `;
            
            // Only update statistics once per game
            if (!gameState.statsUpdated) {
                updateStatistics(won);
                gameState.statsUpdated = true;
                saveGameState();
            }
            startCountdown();
            
            console.log('🏁 endGame function completed');
        }

        function generateShareText() {
            const dayNumber = getDayNumber();
            const guessCount = gameState.won ? gameState.guesses.length : 'X';
            let emojiGrid = '';
            
            for (let i = 0; i < 5; i++) {
                if (i < gameState.guesses.length) {
                    emojiGrid += gameState.guesses[i].correct ? '🟩' : '🟥';
                } else {
                    emojiGrid += '⬜';
                }
            }
            
            const url = window.location.href.split('?')[0];
            return `Bizzle #${dayNumber} ${guessCount}/5\n${emojiGrid}\n\nPlay at ${url}`;
        }

        function shareResult() {
            const shareText = generateShareText();
            const shareButton = document.getElementById('shareButton');
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareText).then(() => {
                    shareButton.textContent = 'Copied!';
                    shareButton.classList.add('copied');
                    setTimeout(() => {
                        shareButton.textContent = 'Share Result';
                        shareButton.classList.remove('copied');
                    }, 2000);
                }).catch(() => {
                    fallbackCopy(shareText);
                });
            } else {
                fallbackCopy(shareText);
            }
        }

        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            
            const shareButton = document.getElementById('shareButton');
            shareButton.textContent = 'Copied!';
            shareButton.classList.add('copied');
            setTimeout(() => {
                shareButton.textContent = 'Share Result';
                shareButton.classList.remove('copied');
            }, 2000);
        }

        function updateStatistics(won) {
            let stats = localStorage.getItem('statistics');
            if (!stats) {
                stats = {
                    gamesPlayed: 0,
                    gamesWon: 0,
                    currentStreak: 0,
                    maxStreak: 0,
                    totalPoints: 0
                };
            } else {
                stats = JSON.parse(stats);
                // Add totalPoints to existing stats if not present
                if (typeof stats.totalPoints === 'undefined') {
                    stats.totalPoints = 0;
                }
            }
            
            stats.gamesPlayed++;
            if (won) {
                stats.gamesWon++;
                stats.currentStreak++;
                stats.totalPoints += gameState.pointsEarned;
                if (stats.currentStreak > stats.maxStreak) {
                    stats.maxStreak = stats.currentStreak;
                }
            } else {
                stats.currentStreak = 0;
            }
            
            localStorage.setItem('statistics', JSON.stringify(stats));
        }

        function displayStatistics() {
            let stats = localStorage.getItem('statistics');
            if (!stats) {
                stats = {
                    gamesPlayed: 0,
                    gamesWon: 0,
                    currentStreak: 0,
                    maxStreak: 0,
                    totalPoints: 0
                };
            } else {
                stats = JSON.parse(stats);
                // Add totalPoints to existing stats if not present
                if (typeof stats.totalPoints === 'undefined') {
                    stats.totalPoints = 0;
                }
            }
            
            document.getElementById('gamesPlayed').textContent = stats.gamesPlayed;
            document.getElementById('winPercentage').textContent = 
                stats.gamesPlayed > 0 
                    ? Math.round((stats.gamesWon / stats.gamesPlayed) * 100) + '%'
                    : '0%';
            document.getElementById('currentStreak').textContent = stats.currentStreak;
            document.getElementById('maxStreak').textContent = stats.maxStreak;
            document.getElementById('totalPoints').textContent = stats.totalPoints;
        }

        function showStats() {
            displayStatistics();
            document.getElementById('statsModal').classList.add('show');
        }

        function closeStats() {
            document.getElementById('statsModal').classList.remove('show');
        }

        function showDebug() {
            updateDebugInfo();
            document.getElementById('debugModal').classList.add('show');
        }

        function closeDebug() {
            document.getElementById('debugModal').classList.remove('show');
        }

        function updateDebugInfo() {
            document.getElementById('debugDay').textContent = getDayNumber();
            document.getElementById('debugGuesses').textContent = gameState.guesses.length;
            
            let state = 'Active';
            if (gameState.won) state = 'Won';
            else if (gameState.lost) state = 'Lost';
            document.getElementById('debugState').textContent = state;
            
            document.getElementById('debugBusiness').textContent = currentBusiness ? currentBusiness.Name : 'Not loaded';
        }

        function clearTodaysGame() {
            if (confirm('Clear today\'s game progress? This will reset your current game.')) {
                localStorage.removeItem('gameState');
                localStorage.removeItem('lastPlayed');
                location.reload();
            }
        }

        function clearAllStats() {
            if (confirm('Clear all statistics? This cannot be undone.')) {
                localStorage.removeItem('statistics');
                alert('Statistics cleared!');
                closeDebug();
            }
        }

        function clearBusinessCache() {
            if (confirm('Clear business data cache? This will force a fresh download.')) {
                localStorage.removeItem('businessCache');
                localStorage.removeItem('businessCacheDate');
                alert('Cache cleared! Refresh to reload data.');
            }
        }

        function clearAllData() {
            if (confirm('⚠️ DANGER: Clear ALL data? This includes game progress, statistics, and cache. This cannot be undone!')) {
                if (confirm('Are you absolutely sure? This will delete everything!')) {
                    localStorage.clear();
                    alert('All data cleared!');
                    location.reload();
                }
            }
        }

        function testPlacesAPI() {
            if (!gameState.correctCoordinates) {
                alert('No coordinates available. Start a game first.');
                return;
            }
            
            console.log('Testing location-aware options with coordinates:', gameState.correctCoordinates);
            console.log('Business type:', currentBusiness?.Category);
            
            fetchPlacesOptions(currentBusiness?.Category || 'Restaurant', gameState.correctCoordinates, 2)
                .then(results => {
                    console.log('Generated Options:', results);
                    const names = results.map(r => r.name || r);
                    alert(`Generated ${results.length} options:\n${names.join('\n')}`);
                })
                .catch(error => {
                    console.error('Option generation failed:', error);
                    alert('Option generation failed. Check console for details.');
                });
        }

        function startCountdown() {
            function updateCountdown() {
                const now = new Date();
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0);
                
                const diff = tomorrow - now;
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                document.getElementById('countdownTime').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            updateCountdown();
            setInterval(updateCountdown, 1000);
        }

        function setupAutocomplete() {
            const input = document.getElementById('guessInput');
            const dropdown = document.getElementById('autocompleteDropdown');
            
            input.addEventListener('input', (e) => {
                const value = e.target.value.toLowerCase().trim();
                if (value.length < 2) {
                    closeAutocomplete();
                    return;
                }
                
                const matches = allBusinesses.filter(business => 
                    business.Name.toLowerCase().includes(value)
                ).slice(0, 5);
                
                if (matches.length === 0) {
                    closeAutocomplete();
                    return;
                }
                
                dropdown.innerHTML = '';
                selectedAutocompleteIndex = -1;
                
                matches.forEach((business, index) => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.textContent = business.Name;
                    item.addEventListener('click', () => {
                        input.value = business.Name;
                        closeAutocomplete();
                        submitGuess();
                    });
                    dropdown.appendChild(item);
                });
                
                dropdown.classList.add('active');
            });
            
            input.addEventListener('keydown', (e) => {
                const items = dropdown.querySelectorAll('.autocomplete-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedAutocompleteIndex = Math.min(selectedAutocompleteIndex + 1, items.length - 1);
                    updateAutocompleteSelection(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedAutocompleteIndex = Math.max(selectedAutocompleteIndex - 1, -1);
                    updateAutocompleteSelection(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (selectedAutocompleteIndex >= 0 && items[selectedAutocompleteIndex]) {
                        input.value = items[selectedAutocompleteIndex].textContent;
                        closeAutocomplete();
                    }
                    submitGuess();
                } else if (e.key === 'Escape') {
                    closeAutocomplete();
                }
            });
            
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    closeAutocomplete();
                }
            });
        }

        function updateAutocompleteSelection(items) {
            items.forEach((item, index) => {
                if (index === selectedAutocompleteIndex) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        function closeAutocomplete() {
            const dropdown = document.getElementById('autocompleteDropdown');
            dropdown.classList.remove('active');
            selectedAutocompleteIndex = -1;
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }

        // Google Maps Integration with async loading support
        function initializeMap() {
            const mapElement = document.getElementById('map');
            if (!mapElement) {
                console.warn('Map element not found');
                return false;
            }
            
            if (!window.google?.maps) {
                console.warn('Google Maps not ready yet');
                return false;
            }
            
            try {
                map = new google.maps.Map(mapElement, {
                    zoom: 11,
                    center: SF_CENTER,
                    disableDefaultUI: true,
                    zoomControl: true,
                    zoomControlOptions: {
                        position: google.maps.ControlPosition.RIGHT_BOTTOM
                    },
                    gestureHandling: 'cooperative',
                    styles: [
                        {
                            featureType: 'poi',
                            elementType: 'labels',
                            stylers: [{ visibility: 'off' }]
                        }
                    ] // Hide POI labels to reduce clutter
                });
                
                console.log('Google Maps initialized successfully');
                return true;
            } catch (error) {
                console.error('Error initializing Google Maps:', error);
                return false;
            }
        }

        function initializeMapIfNeeded() {
            if (!map && window.googleMapsReady) {
                initializeMap();
            }
        }

        function updateMapZoom(level, coordinates) {
            if (!map || !coordinates) {
                console.warn('Map or coordinates not available for zoom update');
                return;
            }
            
            const zoomLevels = {
                1: { zoom: 11, center: SF_CENTER }, // City-wide view
                2: { zoom: 13, center: coordinates }, // Region view
                3: { zoom: 15, center: coordinates }, // Neighborhood view  
                4: { zoom: 17, center: coordinates }, // Street view
                5: { zoom: 19, center: coordinates }  // Exact location
            };
            
            const config = zoomLevels[level];
            if (config) {
                console.log(`Zooming map to level ${level}, zoom: ${config.zoom}`);
                
                // Smooth zoom transition
                map.panTo(config.center);
                map.setZoom(config.zoom);
                
                // Add a subtle hint marker at max zoom (level 4) to show general area
                if (level === 4 && !gameState.won && !gameState.lost) {
                    addLocationHintMarker(coordinates);
                }
            }
        }

        function addLocationHintMarker(coordinates) {
            if (!map || !window.google?.maps) return;
            
            // Remove any existing hint marker
            if (window.hintMarker) {
                window.hintMarker.setMap(null);
            }
            
            // Add a subtle circle to show the general area
            window.hintMarker = new google.maps.Circle({
                strokeColor: '#3B82F6',
                strokeOpacity: 0.6,
                strokeWeight: 2,
                fillColor: '#3B82F6',
                fillOpacity: 0.15,
                map: map,
                center: coordinates,
                radius: 50 // 50 meter radius hint circle
            });
            
            console.log('Added location hint circle');
        }

        function showFinalLocation() {
            if (!map || !gameState.correctCoordinates) {
                console.warn('Cannot show final location: map or coordinates missing');
                return;
            }
            
            console.log('Showing final location with marker');
            
            // Zoom to exact location
            updateMapZoom(5, gameState.correctCoordinates);
            
            // Add the business marker with animation after a short delay
            setTimeout(() => {
                addBusinessMarker(true);
            }, 800);
        }

        function addBusinessMarker(withAnimation = true) {
            if (!map || !gameState.correctCoordinates || !window.google?.maps) {
                console.warn('Cannot add marker: missing requirements');
                return;
            }
            
            // Remove existing markers
            if (businessMarker) {
                businessMarker.setMap(null);
            }
            if (window.hintMarker) {
                window.hintMarker.setMap(null);
                window.hintMarker = null;
            }
            
            console.log('Adding business marker at:', gameState.correctCoordinates);
            
            // Create custom pin icon - using a simple red marker
            const pinIcon = {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                    <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="16" cy="16" r="12" fill="#EF4444" stroke="white" stroke-width="3"/>
                        <circle cx="16" cy="16" r="6" fill="white"/>
                    </svg>
                `),
                scaledSize: new google.maps.Size(32, 32),
                anchor: new google.maps.Point(16, 16)
            };
            
            // Create the marker
            businessMarker = new google.maps.Marker({
                position: gameState.correctCoordinates,
                map: map,
                title: `${currentBusiness.Name}\n${currentBusiness.Address}`,
                icon: pinIcon,
                animation: withAnimation ? google.maps.Animation.DROP : null
            });
            
            // Add info window that opens on click
            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div style="padding: 8px; max-width: 250px;">
                        <h3 style="margin: 0 0 8px 0; color: #1F2937; font-size: 16px;">${currentBusiness.Name}</h3>
                        <p style="margin: 0 0 4px 0; color: #6B7280; font-size: 14px;">📍 ${currentBusiness.Address}</p>
                        <p style="margin: 0 0 4px 0; color: #6B7280; font-size: 14px;">🏷️ ${currentBusiness.Category}</p>
                        ${currentBusiness.Signature ? `<p style="margin: 0; color: #059669; font-size: 14px;">⭐ ${currentBusiness.Signature}</p>` : ''}
                    </div>
                `
            });
            
            // Open info window on marker click
            businessMarker.addListener('click', () => {
                infoWindow.open(map, businessMarker);
            });
            
            // Auto-open info window after marker drops (for final reveals)
            if (withAnimation) {
                setTimeout(() => {
                    infoWindow.open(map, businessMarker);
                }, 1000);
            }
            
            console.log('Business marker added successfully');
        }

        function showMap() {
            const mapContainer = document.getElementById('mapContainer');
            mapContainer.style.display = 'block';
            
            // Initialize map if not already done and Google Maps is ready
            if (!map) {
                if (window.googleMapsReady && window.google?.maps) {
                    if (!initializeMap()) {
                        console.error('Failed to initialize map');
                        return;
                    }
                } else {
                    // Wait for Google Maps to load
                    console.log('Waiting for Google Maps to load...');
                    const checkInterval = setInterval(() => {
                        if (window.googleMapsReady && window.google?.maps) {
                            clearInterval(checkInterval);
                            if (initializeMap()) {
                                console.log('Map initialized after waiting');
                            }
                        }
                    }, 100);
                    
                    // Timeout after 10 seconds
                    setTimeout(() => {
                        clearInterval(checkInterval);
                        if (!map) {
                            console.error('Google Maps failed to load within timeout');
                        }
                    }, 10000);
                }
            }
        }

        function hideMap() {
            const mapContainer = document.getElementById('mapContainer');
            mapContainer.style.display = 'none';
        }

        // Multiple Choice System with Places API
        async function generateMultipleChoice(businessType, coordinates, radiusMiles) {
            try {
                // Try Places API first
                const placesOptions = await fetchPlacesOptions(businessType, coordinates, radiusMiles);
                
                if (placesOptions.length >= 3) {
                    // Use Places API results
                    const decoys = placesOptions
                        .filter(place => place.name !== currentBusiness.Name)
                        .slice(0, 7); // Take up to 7 decoys
                    
                    const options = [...decoys.map(place => place.name), currentBusiness.Name];
                    return shuffleArray(options);
                } else {
                    // Fallback to curated options if Places API doesn't return enough
                    return generateFallbackOptions();
                }
                
            } catch (error) {
                console.error('Error generating multiple choice:', error);
                // Fallback to curated options
                return generateFallbackOptions();
            }
        }

        async function fetchPlacesOptions(businessType, coordinates, radiusMiles) {
            try {
                // Check cache first
                const cacheKey = `places_${businessType}_${coordinates.lat.toFixed(3)}_${coordinates.lng.toFixed(3)}_${radiusMiles}`;
                const cached = localStorage.getItem(cacheKey);
                const cacheExpiry = localStorage.getItem(`${cacheKey}_expiry`);
                
                // Use cache if it's less than 24 hours old
                if (cached && cacheExpiry && Date.now() < parseInt(cacheExpiry)) {
                    return JSON.parse(cached);
                }
                
                // Use new Places API (New) with Text Search
                const placeType = mapBusinessTypeToPlaceType(businessType);
                const searchQuery = `${placeType} near ${coordinates.lat},${coordinates.lng}`;
                
                // Convert miles to meters for radius
                const radiusMeters = Math.min(radiusMiles * 1609.34, 50000); // Max 50km radius
                
                // Note: Places API requires server-side implementation due to CORS restrictions
                // For client-side only implementation, we'll use enhanced curated options
                console.log('Using enhanced curated options for:', placeType, 'near', coordinates);
                
                // Generate location-aware curated options
                const curatedOptions = generateLocationAwareFallback(placeType, coordinates, radiusMiles);
                
                // Cache the curated results
                localStorage.setItem(cacheKey, JSON.stringify(curatedOptions));
                localStorage.setItem(`${cacheKey}_expiry`, (Date.now() + 24 * 60 * 60 * 1000).toString());
                
                return curatedOptions;
                
            } catch (error) {
                console.error('Error fetching Places API data:', error);
                return [];
            }
        }

        function mapBusinessTypeToPlaceType(businessType) {
            // Map business categories to search terms for Text Search API
            const typeMapping = {
                'Bakery': 'bakery',
                'Restaurant': 'restaurant', 
                'Coffee': 'coffee shop',
                'Bar': 'bar',
                'Store': 'store',
                'Shop': 'shop',
                'Market': 'grocery store',
                'Cafe': 'cafe',
                'Pizza': 'pizza restaurant',
                'Deli': 'deli',
                'Donut': 'donut shop',
                'Sandwich': 'sandwich shop',
                'Mexican': 'mexican restaurant',
                'Chinese': 'chinese restaurant',
                'Italian': 'italian restaurant',
                'Thai': 'thai restaurant'
            };
            
            if (!businessType) return 'restaurant';
            
            // Try to find a specific match first
            for (const [key, value] of Object.entries(typeMapping)) {
                if (businessType.toLowerCase().includes(key.toLowerCase())) {
                    return value;
                }
            }
            
            // Fallback based on common patterns
            const lowerType = businessType.toLowerCase();
            if (lowerType.includes('food') || lowerType.includes('eat')) {
                return 'restaurant';
            } else if (lowerType.includes('drink') || lowerType.includes('beverage')) {
                return 'cafe';
            } else if (lowerType.includes('shop') || lowerType.includes('store')) {
                return 'store';
            }
            
            return 'restaurant'; // Most common fallback
        }

        function generateLocationAwareFallback(placeType, coordinates, radiusMiles) {
            // Enhanced location-aware curated options
            const sfBusinesses = {
                bakery: [
                    'Tartine Bakery', 'Arizmendi Bakery', 'Jane the Bakery', 
                    'Craftsman and Wolves', 'B. Patisserie', 'Boudin Bakery',
                    'The Mill', 'Devil\'s Teeth Baking Company', 'Arsicault Bakery'
                ],
                'coffee shop': [
                    'Blue Bottle Coffee', 'Ritual Coffee', 'Sightglass Coffee',
                    'Philz Coffee', 'The Mill', 'Four Barrel Coffee',
                    'Saint Frank Coffee', 'Wrecking Ball Coffee'
                ],
                restaurant: [
                    'Zuni Cafe', 'State Bird Provisions', 'Gary Danko',
                    'House of Prime Rib', 'Swan Oyster Depot', 'Tadich Grill',
                    'The Slanted Door', 'Foreign Cinema', 'Chez Panisse'
                ],
                'donut shop': [
                    'Bob\'s Donuts', 'Johnny Doughnuts', 'Dynamo Donut',
                    'Pepples Donut Farm', 'Stan\'s Donuts', 'Happy Donuts'
                ],
                'mexican restaurant': [
                    'La Taqueria', 'El Farolito', 'Papalote Mexican Grill',
                    'Nopalito', 'Comal', 'Panchita\'s'
                ],
                bar: [
                    'Trick Dog', 'ABV', 'Bourbon & Branch', 'The Alembic',
                    'Local Edition', 'Zeitgeist', 'Tony Nik\'s'
                ],
                cafe: [
                    'Cafe Zoetrope', 'Cafe Trieste', 'Mama\'s on Washington Square',
                    'Peet\'s Coffee', 'Starbucks', 'Cafe Central'
                ]
            };
            
            // Get appropriate category options
            let options = sfBusinesses[placeType] || sfBusinesses.restaurant;
            
            // Add some cross-category variety for realism
            if (placeType !== 'restaurant') {
                options = [...options, ...sfBusinesses.restaurant.slice(0, 2)];
            }
            
            // Simulate distance-based filtering (closer = more specific)
            if (radiusMiles < 1) {
                // Very close - fewer, more specific options
                options = options.slice(0, 6);
            } else if (radiusMiles < 3) {
                // Neighborhood - moderate options
                options = options.slice(0, 8);
            }
            
            // Return as Place-like objects
            return options.map(name => ({
                name: name,
                rating: Math.random() * 2 + 3, // Random rating 3-5
                vicinity: 'San Francisco, CA'
            }));
        }

        function generateFallbackOptions() {
            // Simple fallback when no coordinates are available
            return generateLocationAwareFallback(
                mapBusinessTypeToPlaceType(currentBusiness.Category),
                SF_CENTER,
                10
            ).map(place => place.name);
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function showMultipleChoice(options) {
            const container = document.getElementById('multipleChoiceContainer');
            const grid = document.getElementById('choiceGrid');
            
            // Clear existing options
            grid.innerHTML = '';
            
            // Create choice buttons
            options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'choice-button';
                button.textContent = option;
                button.onclick = () => handleMultipleChoiceGuess(option, button);
                grid.appendChild(button);
            });
            
            container.style.display = 'block';
        }

        function hideMultipleChoice() {
            const container = document.getElementById('multipleChoiceContainer');
            container.style.display = 'none';
        }

        function handleMultipleChoiceGuess(guess, buttonElement) {
            const isCorrect = guess === currentBusiness.Name;
            
            // Visual feedback
            buttonElement.classList.add(isCorrect ? 'correct' : 'wrong');
            
            // Disable all buttons
            const allButtons = document.querySelectorAll('.choice-button');
            allButtons.forEach(btn => btn.style.pointerEvents = 'none');
            
            // Add to game state
            gameState.guesses.push({
                text: guess,
                correct: isCorrect
            });
            
            setTimeout(() => {
                if (isCorrect) {
                    gameState.won = true;
                    gameState.pointsEarned = calculatePoints(gameState.guesses.length);
                    // Immediately add marker when they get it right
                    addBusinessMarker(true);
                    // Also zoom to exact location if not already there
                    if (gameState.round < 4) {
                        updateMapZoom(5, gameState.correctCoordinates);
                    }
                    // Show winning message after a brief moment to see the marker
                    setTimeout(() => {
                        endGame(true);
                    }, 1500);
                } else if (gameState.round >= 4) {
                    // Out of rounds - show final location
                    gameState.lost = true;
                    showFinalLocation();
                    setTimeout(() => {
                        endGame(false);
                    }, 1000);
                } else {
                    // Progress to next round with zoom
                    gameState.round++;
                    progressToNextRound();
                }
                saveGameState();
            }, 1500);
        }

        async function init() {
            try {
                allBusinesses = await fetchBusinessData();
                
                if (allBusinesses.length === 0) {
                    throw new Error('No businesses available');
                }
                
                currentBusiness = getTodaysBusiness(allBusinesses);
                
                if (!currentBusiness) {
                    throw new Error('Could not load today\'s business');
                }
                
                document.getElementById('businessPhoto').src = currentBusiness.PhotoURL;
                document.getElementById('funFact').textContent = currentBusiness.FunFact;
                // Note: hint content is now populated dynamically via revealHint() function
                
                // Pre-load coordinates for better performance
                if (currentBusiness.Address) {
                    geocodeAddress(currentBusiness.Address).then(coords => {
                        gameState.correctCoordinates = coords;
                    }).catch(error => {
                        console.warn('Failed to pre-load coordinates:', error);
                    });
                }
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('gameContent').style.display = 'block';
                
                initializeGame();
                setupAutocomplete();
                
                // Restore UI state after business is loaded
                if (gameState.hintsRevealed > 0 || gameState.won || gameState.lost) {
                    restoreGameUI();
                }
                
                document.getElementById('guessInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && selectedAutocompleteIndex === -1) {
                        e.preventDefault();
                        submitGuess();
                    }
                });
                
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        const statsModal = document.getElementById('statsModal');
                        const debugModal = document.getElementById('debugModal');
                        if (statsModal.classList.contains('show')) {
                            closeStats();
                        } else if (debugModal.classList.contains('show')) {
                            closeDebug();
                        }
                    }
                });
                
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('loading').style.display = 'none';
                showError('Failed to initialize game. Please refresh the page.');
            }
        }

        init();
    </script>
</body>
</html>